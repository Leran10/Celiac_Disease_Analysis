---
title: "Celiac_reads_based_pairwise_timeSeries_analysis_01162025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(readxl)
library(broom.mixed)
library(DESeq2)
library(ggrepel)
library(pheatmap)
library(phyloseq)
library(pROC)
library(lme4)
library(survival)
library(survminer)
```


# import metadata and reads table
```{r}

# metadata
metadata.final <- read.csv("~/Handley Lab Dropbox/16S/Celiac/metadata/metadata_final_update_11262024.csv") #%>%
                  # mutate(sampleName = ifelse(sampleName %like% "_6Y",gsub("_6Y","_72M",sampleName),
                  #                          ifelse(sampleName %like% "_7Y",gsub("_7Y","_84M",sampleName),sampleName))) %>%
                  #  mutate(Sample.Name.External.ID = ifelse(Sample.Name.External.ID %like% "_6Y",gsub("_6Y","_72M",Sample.Name.External.ID),
                  #                          ifelse(Sample.Name.External.ID %like% "_7Y",gsub("_7Y","_84M",Sample.Name.External.ID),Sample.Name.External.ID))) %>%
                  #  mutate(Sample_full_name = ifelse(Sample_full_name %like% "_6Y",gsub("_6Y","_72M",Sample_full_name),
                  #                          ifelse(Sample_full_name %like% "_7Y",gsub("_7Y","_84M",Sample_full_name),Sample_full_name)))


# import virus of interest
vv.foi <- as_tibble(fread("~/Handley Lab Dropbox/16S/Celiac/tables/Vertebrate_viruses_strain_counts.tsv",header = TRUE)) %>%
                  mutate(sampleName = ifelse(sampleName %like% "_6Y",gsub("_6Y","_72M",sampleName),
                                           ifelse(sampleName %like% "_7Y",gsub("_7Y","_84M",sampleName),sampleName))) %>%
                   mutate(sampleID = ifelse(sampleID %like% "_6Y",gsub("_6Y","_72M",sampleID),
                                           ifelse(sampleID %like% "_7Y",gsub("_7Y","_84M",sampleID),sampleID))) %>%
                   mutate(sampleID_mod = ifelse(sampleID_mod %like% "_6Y",gsub("_6Y","_72M",sampleID_mod),
                                           ifelse(sampleID_mod %like% "_7Y",gsub("_7Y","_84M",sampleID_mod),sampleID_mod)))

```


# extract count table
```{r}

count.raw <-left_join(metadata.final,vv.foi,by = "sampleName")
count.raw$count[is.na(count.raw$count)] <- 0
count.species <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family","genus","species"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_species = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_species", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")


# OTU = otu_table(count.species, taxa_are_rows = TRUE)
# TAX = tax_table(tax_mat)
# samples = sample_data(metadata.final.deseq)
# 
# ps0.virus.species <-phyloseq(OTU, samples)
# saveRDS(ps0.virus.species,"~/Handley Lab Dropbox/16S/Celiac/ps0.virus.species.rds")


count.genus <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family","genus"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_genus = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_genus", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")




count.family <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_family = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_family", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")


```


# prepare abundance table
```{r}

# ---------------------------------Species level------------------------------------------#

count.species.abundance <- count.species

# merge count table and metadata table
abundance.table.all.species <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.abundance),by = 0) %>%
                              filter(feeding_first_year != "Unknown") %>%
                              filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                              filter(Age.at.Gluten.Introduction..months. != "Unknown")


# ---------------------------------genus level------------------------------------------#

# create genus abundance table
count.genus.abundance <- count.genus

# merge count table and metadata table
abundance.table.all.genus <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.abundance),by = 0) %>%
                            filter(feeding_first_year != "Unknown") %>%
                            filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                            filter(Age.at.Gluten.Introduction..months. != "Unknown")




# ---------------------------------family level------------------------------------------#


# create genus abundance table
count.family.abundance <- count.family

# merge count table and metadata table
abundance.table.all.family <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.family.abundance),by = 0) %>%
                            filter(feeding_first_year != "Unknown") %>%
                            filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                            filter(Age.at.Gluten.Introduction..months. != "Unknown")


```


# prepare PA table
```{r}

# ---------------------------------Species level------------------------------------------#
count.species.PA <- count.species
count.species.PA[count.species.PA != 0] <- 1


PA.table.species.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.PA),by = 0) %>%
                        # filter(feeding_first_year != "Unknown") %>%
                        # filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        # filter(Age.at.Gluten.Introduction..months. != "Unknown") %>%
                        group_by(patientID) %>%
                        mutate(last_time_point = max(month)) %>%
                        ungroup() %>%
                        mutate(Onset.or.not.Dx = ifelse(Dx.Status == "CELIAC",Onset.Dx,last_time_point))



dim(PA.table.species.all %>% filter(Dx.Status == "CONTROL") %>% distinct(patientID,.keep_all = TRUE))
table(PA.table.species.all %>%  distinct(patientID,.keep_all = TRUE) %>% pull(Dx.Status))
 # CELIAC CONTROL 
 #     36      36 

# ---------------------------------genus level------------------------------------------#
count.genus.PA <- count.genus
count.genus.PA[count.genus.PA != 0] <- 1


PA.table.genus.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.PA),by = 0) %>%
                        # filter(feeding_first_year != "Unknown") %>%
                        # filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        # filter(Age.at.Gluten.Introduction..months. != "Unknown") %>%
                        group_by(patientID) %>%
                        mutate(last_time_point = max(month)) %>%
                        ungroup() %>%
                        mutate(Onset.or.not.Dx = ifelse(Dx.Status == "CELIAC",Onset.Dx,last_time_point))


# ---------------------------------family level------------------------------------------#
count.family.PA <- count.family
count.family.PA[count.family.PA != 0] <- 1


PA.table.family.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.family.PA),by = 0) %>%
                        # filter(feeding_first_year != "Unknown") %>%
                        # filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        # filter(Age.at.Gluten.Introduction..months. != "Unknown") %>%
                        group_by(patientID) %>%
                        mutate(last_time_point = max(month)) %>%
                        ungroup() %>%
                        mutate(Onset.or.not.Dx = ifelse(Dx.Status == "CELIAC",Onset.Dx,last_time_point))

```



# prevelance filtering (we remove the viruses that only contain less than 4 samples)
```{r}


PA.species.check <- PA.table.species.all %>% 
                   dplyr::select(Row.names,starts_with("Viruses")) %>% 
                   pivot_longer(cols = starts_with("Viruses"),names_to = "Species",values_to = "PA") %>% 
                   group_by(Species) %>% 
                   mutate(total_PA = sum(PA)) %>%
                   distinct(Species,total_PA) %>%
                   arrange(total_PA)

write.csv(PA.species.check,"~/Handley Lab Dropbox/16S/Celiac/plot/check_tables/PA.species.check.csv")



# find viruses that exist in only 3% of the samples (230 virusese are removed and 89 viruses left)
rare_species_0.3 <- PA.species.check %>% filter(total_PA < 9) %>% pull(Species)
PA.table.species.all.prev <- PA.table.species.all %>% dplyr::select(-rare_species_0.3)

table(PA.table.species.all.prev %>%  distinct(patientID,.keep_all = TRUE) %>% pull(Dx.Status))
 # CELIAC CONTROL 
 #     36      36

PA.genus.check <- PA.table.genus.all %>% 
                   dplyr::select(Row.names,starts_with("Viruses")) %>% 
                   pivot_longer(cols = starts_with("Viruses"),names_to = "Genus",values_to = "PA") %>% 
                   group_by(Genus) %>% 
                   mutate(total_PA = sum(PA)) %>%
                   distinct(Genus,total_PA) %>%
                   arrange(total_PA)


write.csv(PA.genus.check,"~/Handley Lab Dropbox/16S/Celiac/plot/check_tables/PA.genus.check.csv")


# find viruses that exist in only 3% of the samples (24 virusese are removed and 55 viruses left)
rare_genus_0.3 <- PA.genus.check %>% filter(total_PA < 9) %>% pull(Genus)
PA.table.genus.all.prev <- PA.table.genus.all %>% dplyr::select(-rare_genus_0.3)


PA.family.check <- PA.table.family.all %>% 
                   dplyr::select(Row.names,starts_with("Viruses")) %>% 
                   pivot_longer(cols = starts_with("Viruses"),names_to = "Family",values_to = "PA") %>% 
                   group_by(Family) %>% 
                   mutate(total_PA = sum(PA)) %>%
                   distinct(Family,total_PA) %>%
                   arrange(total_PA)


write.csv(PA.family.check,"~/Handley Lab Dropbox/16S/Celiac/plot/check_tables/PA.family.check.csv")


# find viruses that exist in only 3% of the samples (24 virusese are removed and 55 viruses left)
rare_family_0.3 <- PA.family.check %>% filter(total_PA < 9) %>% pull(Family)
PA.table.family.all.prev <- PA.table.family.all %>% dplyr::select(-rare_family_0.3)



```


                                            ###########################################################################
                                            #   What are the differences between case and control in each timepoint   #               
                                            #                                                                         #
                                            ###########################################################################
                                            


                                                                  ###############################
                                                                  #  LRT on abundance of virus  #
                                                                  ###############################



################
#    Family    #
################
```{r}

# modify metadata table for deseq analysis
metadata.final.deseq <- metadata.final %>%
                        column_to_rownames("sampleName") %>%
                        dplyr::rename("Disease_status" = "Dx.Status") %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")


# trim the samples in count.species table to consistent with the metadata table
count.family.deseq <- count.family %>%
                       dplyr::select(rownames(metadata.final.deseq))
dim(count.family.deseq)
# 13 298


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.deseq <- metadata.final.deseq[colnames(count.family.deseq),]
# 298  24


# make the month variable factor
metadata.final.deseq$month <- factor(metadata.final.deseq$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
metadata.final.deseq$Disease_status <- factor(metadata.final.deseq$Disease_status,levels = c("CONTROL","CELIAC"))
metadata.final.deseq$Age.at.Gluten.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Gluten.Introduction..months.)
metadata.final.deseq$Age.at.Solid.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Solid.Introduction..months.)

rownames(count.family.deseq) <- gsub("/","_",rownames(count.family.deseq))


# NOTE: since some counts are supper big (max:2286983738). And these values will become NA in the process of DESeqDataSetFromMatrix().
# One way is to scale the entire data by 2, that is divide the entire count table by 2, and round it up.
# reference: https://chat.stackoverflow.com/rooms/223701/discussion-between-stupidwolf-and-jack-henry
# trim the samples in count.species table to consistent with the metadata table
count.family.deseq.scale <- round(count.family.deseq /6)


# design the model
ddsTC <- DESeqDataSetFromMatrix(countData = count.family.deseq.scale + 1,
                                colData = metadata.final.deseq,
                                design = ~ Country + Sex + Delivery.Mode + HLA.Category + Age.at.Solid.Introduction..months. + Age.at.Solid.Introduction..months. + Disease_status + month + Disease_status:month)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
ddsTC <- DESeq(ddsTC, test="LRT", reduced = ~ Country + Sex + Delivery.Mode + HLA.Category + Age.at.Solid.Introduction..months. + Age.at.Solid.Introduction..months. + Disease_status + month)

# check the result of analysis
resTC <- results(ddsTC)

# extract the result table
res.table <- resTC[order(resTC$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)

resultsNames(ddsTC)
# "Intercept"                               "Country_USA_vs_ITALY"                    "Sex_Male_vs_Female"                      "Delivery.Mode_Vaginal_vs_C.Section"     
# "HLA.Category_Low.No.Risk_vs_High.Risk"   "HLA.Category_Standard.Risk_vs_High.Risk" "Disease_status_CELIAC_vs_CONTROL"        "month_18_vs_12"                         
# "month_24_vs_12"                          "month_30_vs_12"                          "month_36_vs_12"                          "month_48_vs_12"                         
# "month_54_vs_12"                          "month_60_vs_12"                          "month_72_vs_12"                          "month_84_vs_12"                         
# "Disease_statusCELIAC.month18"            "Disease_statusCELIAC.month24"            "Disease_statusCELIAC.month30"            "Disease_statusCELIAC.month36"           
# "Disease_statusCELIAC.month48"            "Disease_statusCELIAC.month54"            "Disease_statusCELIAC.month60"            "Disease_statusCELIAC.month72"           
# "Disease_statusCELIAC.month84" 



for (i in resultsNames(ddsTC)[2:25]){
  
    res.case_control <- results(ddsTC, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    #write.csv(res.case_control,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/family/",i,"_sig_family.csv"))
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
      
       print(j)
        
        padj <- res.case_control$padj
        stats <- res.case_control$stat
        
        count.plot <- plotCounts(ddsTC, j,
                   intgroup = c("month","Disease_status"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Disease_status <- factor(count.plot$Disease_status,levels = c("CONTROL","CELIAC"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Disease_status, group = Disease_status)) + 
                geom_point() + 
                scale_color_manual(breaks = c("CONTROL","CELIAC"), 
                       values=c("#09bc8a","#d81e5b")) + 
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/family/",i,"_",j,"_count_plot.pdf")
       # ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


res.case_control.list <- list()

ddsResNames <- resultsNames(ddsTC)[2:25]


for (i in (1:length(ddsResNames))){
   
      
      res.case_control.list[[i]] <-  results(ddsTC, name=ddsResNames[i], test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    dplyr::select(log2FoldChange) %>% 
                    rename("log2FoldChange" = ddsResNames[i]) %>%
                    rownames_to_column("rowname")
      

}


res.case_control.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.case_control.list)
res.case_control.total[is.na(res.case_control.total)] <- 0
res.case_control.total <- res.case_control.total %>%
                          column_to_rownames("rowname")


thr <- 20
res.case_control.total[res.case_control.total < -thr] <- -thr
res.case_control.total[res.case_control.total > thr] <- thr

ggsave(pheatmap(res.case_control.total, color = hcl.colors(50, "BluYl"), length=101,
                   cluster_col=FALSE,fontsize_row = 20,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/family/sig.family.heatmap.pdf",width = 30, height = 8, dpi=600)


```


################
#    Genus     #
################
```{r}

# modify metadata table for deseq analysis
metadata.final.deseq <- metadata.final %>%
                        column_to_rownames("sampleName") %>%
                        dplyr::rename("Disease_status" = "Dx.Status") %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")


# trim the samples in count.species table to consistent with the metadata table
count.genus.deseq <- count.genus %>%
                       dplyr::select(rownames(metadata.final.deseq))
dim(count.genus.deseq)
# 52 298


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.deseq <- metadata.final.deseq[colnames(count.genus.deseq),]
# 298  24


# make the month variable factor
metadata.final.deseq$month <- factor(metadata.final.deseq$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
metadata.final.deseq$Disease_status <- factor(metadata.final.deseq$Disease_status,levels = c("CONTROL","CELIAC"))
metadata.final.deseq$Age.at.Gluten.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Gluten.Introduction..months.)
metadata.final.deseq$Age.at.Solid.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Solid.Introduction..months.)

rownames(count.genus.deseq) <- gsub("/","_",rownames(count.genus.deseq))


# NOTE: since some counts are supper big (max:2286983738). And these values will become NA in the process of DESeqDataSetFromMatrix().
# One way is to scale the entire data by 2, that is divide the entire count table by 2, and round it up.
# reference: https://chat.stackoverflow.com/rooms/223701/discussion-between-stupidwolf-and-jack-henry
# trim the samples in count.species table to consistent with the metadata table
count.genus.deseq.scale <- round(count.genus.deseq /4)


# design the model
ddsTC <- DESeqDataSetFromMatrix(countData = count.genus.deseq.scale + 1,
                                colData = metadata.final.deseq,
                                design = ~ Country + Sex + Delivery.Mode + HLA.Category + Age.at.Solid.Introduction..months. + Age.at.Solid.Introduction..months. + Disease_status + month + Disease_status:month)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
ddsTC <- DESeq(ddsTC, test="LRT", reduced = ~ Country + Sex + Delivery.Mode + HLA.Category + Age.at.Solid.Introduction..months. + Age.at.Solid.Introduction..months. + Disease_status + month)

# check the result of analysis
resTC <- results(ddsTC)

# extract the result table
res.table <- resTC[order(resTC$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)

resultsNames(ddsTC)
# "Intercept"                               "Country_USA_vs_ITALY"                    "Sex_Male_vs_Female"                      "Delivery.Mode_Vaginal_vs_C.Section"     
# "HLA.Category_Low.No.Risk_vs_High.Risk"   "HLA.Category_Standard.Risk_vs_High.Risk" "Disease_status_CELIAC_vs_CONTROL"        "month_18_vs_12"                         
# "month_24_vs_12"                          "month_30_vs_12"                          "month_36_vs_12"                          "month_48_vs_12"                         
# "month_54_vs_12"                          "month_60_vs_12"                          "month_72_vs_12"                          "month_84_vs_12"                         
# "Disease_statusCELIAC.month18"            "Disease_statusCELIAC.month24"            "Disease_statusCELIAC.month30"            "Disease_statusCELIAC.month36"           
# "Disease_statusCELIAC.month48"            "Disease_statusCELIAC.month54"            "Disease_statusCELIAC.month60"            "Disease_statusCELIAC.month72"           
# "Disease_statusCELIAC.month84" 



for (i in resultsNames(ddsTC)[2:25]){
  
    res.case_control <- results(ddsTC, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    write.csv(res.case_control,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/genus/",i,"_sig_genus.csv"))
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
      
       print(j)
        
        padj <- res.case_control$padj
        stats <- res.case_control$stat
        
        count.plot <- plotCounts(ddsTC, j,
                   intgroup = c("month","Disease_status"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Disease_status <- factor(count.plot$Disease_status,levels = c("CONTROL","CELIAC"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Disease_status, group = Disease_status)) + 
                geom_point() + 
                scale_color_manual(breaks = c("CONTROL","CELIAC"), 
                       values=c("#09bc8a","#d81e5b")) + 
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/genus/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


res.case_control.list <- list()

ddsResNames <- resultsNames(ddsTC)[2:25]


for (i in (1:length(ddsResNames))){
   
      
      res.case_control.list[[i]] <-  results(ddsTC, name=ddsResNames[i], test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    dplyr::select(log2FoldChange) %>% 
                    rename("log2FoldChange" = ddsResNames[i]) %>%
                    rownames_to_column("rowname")
      

}


res.case_control.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.case_control.list)
res.case_control.total[is.na(res.case_control.total)] <- 0
res.case_control.total <- res.case_control.total %>%
                          column_to_rownames("rowname")


thr <- 20
res.case_control.total[res.case_control.total < -thr] <- -thr
res.case_control.total[res.case_control.total > thr] <- thr

ggsave(pheatmap(res.case_control.total, color = hcl.colors(50, "BluYl"), length=101,
                   cluster_col=FALSE,fontsize_row = 20,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/genus/sig.genus.heatmap.pdf",width = 30, height = 12, dpi=600)


```



################
#    Species   #
################
```{r}

# modify metadata table for deseq analysis
metadata.final.deseq <- metadata.final %>%
                        column_to_rownames("sampleName") %>%
                        dplyr::rename("Disease_status" = "Dx.Status") %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")
dim(metadata.final.deseq)
# 298  24


# trim the samples in count.species table to consistent with the metadata table
count.species.deseq <- count.species %>%
                       dplyr::select(rownames(metadata.final.deseq))

dim(count.species.deseq)
# 292 298


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.deseq <- metadata.final.deseq[colnames(count.species.deseq),]
# 298  24
        

# make the month variable factor
metadata.final.deseq$month <- factor(metadata.final.deseq$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
metadata.final.deseq$Disease_status <- factor(metadata.final.deseq$Disease_status,levels = c("CONTROL","CELIAC"))
metadata.final.deseq$Age.at.Gluten.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Gluten.Introduction..months.)
metadata.final.deseq$Age.at.Solid.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Solid.Introduction..months.)

rownames(count.species.deseq) <- gsub("/","_",rownames(count.species.deseq))


# NOTE: since some counts are supper big (max:2286983738). And these values will become NA in the process of DESeqDataSetFromMatrix().
# One way is to scale the entire data by 2, that is divide the entire count table by 2, and round it up.
# reference: https://chat.stackoverflow.com/rooms/223701/discussion-between-stupidwolf-and-jack-henry

count.species.deseq.scale <- round(count.species.deseq /2)

# design the model
ddsTC <- DESeqDataSetFromMatrix(countData = count.species.deseq.scale + 1,
                                colData = metadata.final.deseq,
                                design = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month + feeding_first_year + as.numeric(Age.at.Solid.Introduction..months.) + as.numeric(Age.at.Gluten.Introduction..months.) + Disease_status:month)  # Disease_status + month + 



table(metadata.final.deseq$feeding_first_year)
# Breast_fed       Breastmilk_and_formula                Formula 
#        119                    124                        55

table(metadata.final.deseq$Country)
# ITALY   USA 
#   101   197 

table(metadata.final.deseq$Sex)
# Female   Male 
#    231     67

table(metadata.final.deseq$Age.at.Solid.Introduction..months.)
 #  4   5   6   7   8  10 
 # 37  80 118  57   5   1 



table(metadata.final.deseq$Delivery.Mode)
# C-Section   Vaginal 
#        84       214 


table(metadata.final.deseq$HLA.Category)
    # High Risk   Low/No Risk Standard Risk 
    #        86            48           164 


# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
ddsTC <- DESeq(ddsTC, test="LRT", reduced = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month + feeding_first_year + as.numeric(Age.at.Solid.Introduction..months.) + as.numeric(Age.at.Gluten.Introduction..months.))



# check the result of analysis
resTC <- results(ddsTC)

# extract the result table
res.table <- resTC[order(resTC$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)


resultsNames(ddsTC)
# [1] "Intercept"                                               "Country_USA_vs_ITALY"                                   
#  [3] "Sex_Male_vs_Female"                                      "Delivery.Mode_Vaginal_vs_C.Section"                     
#  [5] "HLA.Category_Low.No.Risk_vs_High.Risk"                   "HLA.Category_Standard.Risk_vs_High.Risk"                
#  [7] "Disease_status_CELIAC_vs_CONTROL"                        "month_18_vs_12"                                         
#  [9] "month_24_vs_12"                                          "month_30_vs_12"                                         
# [11] "month_36_vs_12"                                          "month_48_vs_12"                                         
# [13] "month_54_vs_12"                                          "month_60_vs_12"                                         
# [15] "month_72_vs_12"                                          "month_84_vs_12"                                         
# [17] "feeding_first_year_Breastmilk_and_formula_vs_Breast_fed" "feeding_first_year_Formula_vs_Breast_fed"               
# [19] "as.numeric.Age.at.Solid.Introduction..months.."          "as.numeric.Age.at.Gluten.Introduction..months.."        
# [21] "Disease_statusCELIAC.month18"                            "Disease_statusCELIAC.month24"                           
# [23] "Disease_statusCELIAC.month30"                            "Disease_statusCELIAC.month36"                           
# [25] "Disease_statusCELIAC.month48"                            "Disease_statusCELIAC.month54"                           
# [27] "Disease_statusCELIAC.month60"                            "Disease_statusCELIAC.month72"                           
# [29] "Disease_statusCELIAC.month84"          



for (i in resultsNames(ddsTC)[2:29]){
  
    res.case_control <- results(ddsTC, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    print(dim(res.case_control))
    
    #write.csv(res.case_control,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/species/",i,"_sig_species.csv"))
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
        
        df <- res.case_control %>% filter(rownames(res.case_control) == j)
        
        padj <- df %>% pull(padj)
        stats <- df %>% pull(log2FoldChange)
        
        count.plot <- plotCounts(ddsTC, j,
                   intgroup = c("month","Disease_status"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Disease_status <- factor(count.plot$Disease_status,levels = c("CONTROL","CELIAC"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Disease_status, group = Disease_status)) + 
                geom_jitter(width = 0.3) + 
                scale_color_manual(breaks = c("CONTROL","CELIAC"), 
                       values=c("#09bc8a","#d81e5b")) +  
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/species/",i,"_",j,"_count_plot.pdf")
        #ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


res.case_control.list <- list()

ddsResNames <- resultsNames(ddsTC)[2:29]


for (i in (1:length(ddsResNames))){
  
     df <- results(ddsTC, name=ddsResNames[i], test="Wald") %>%
                                      data.frame(.) %>%
                                      filter(padj < 0.05) %>%
                                      dplyr::select(log2FoldChange) #%>% 
     
     colnames(df) <- ddsResNames[i]
     
     df <- df %>%
           rownames_to_column("rowname")
   
      
      res.case_control.list[[i]] <-  df


}



res.case_control.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.case_control.list)
res.case_control.total[is.na(res.case_control.total)] <- 0
res.case_control.total <- res.case_control.total %>%
                          column_to_rownames("rowname")

thr <- 7
res.case_control.total[res.case_control.total < -thr] <- -thr
res.case_control.total[res.case_control.total > thr] <- thr


ggsave(pheatmap(res.case_control.total, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 25,fontsize_col = 25),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/species/sig.species.heatmap.moreVariable.pdf",width = 40, height = 30, dpi=600)



###############################
#  below are not use for now  #
###############################


# extract the rellevant comparisons and viruses and remake the heatmap
res.case_control.total.relevant <- res.case_control.total %>%
                                   select("Disease_statusCELIAC.month18","Disease_statusCELIAC.month24","Disease_statusCELIAC.month30","Disease_statusCELIAC.month36","Disease_statusCELIAC.month48","Disease_statusCELIAC.month54","Disease_statusCELIAC.month60","Disease_statusCELIAC.month72","Disease_statusCELIAC.month84") %>%
  filter(rownames(.) %in% c("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Caliciviridae;unclassified Caliciviridae genus;unclassified Caliciviridae species",
                            "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus",
                            "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Human mastadenovirus C",
                            "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Torque teno virus",
                            "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;unclassified Anelloviridae species",
                            "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;unclassified Picornavirales family;unclassified Picornavirales genus;unclassified Picornavirales species",
                           "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus;Torque teno mini virus 8",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Primate bocaparvovirus 1",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Bocaparvovirus sp.",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Bocavirus PgBoV-1"))
                                   


thr <- 7
res.case_control.total.relevant[res.case_control.total.relevant < -thr] <- -thr
res.case_control.total.relevant[res.case_control.total.relevant > thr] <- thr


ggsave(pheatmap(res.case_control.total.relevant, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 25,fontsize_col = 25),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/sig.species.heatmap.relevant.pdf",width = 40, height = 15, dpi=600)



# boxplot for celiac vs control groups
count.species.case_control <- count.species
match(metadata.final[,"sampleName"], names(count.species.case_control))
names(count.species.case_control)[match(metadata.final[,"sampleName"], names(count.species.case_control))] = metadata.final[,"Dx.Status"]


res.case_control <- results(ddsTC, name="Disease_status_CELIAC_vs_CONTROL", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)


count.species.case_control.sig.df <- count.species.case_control %>%
                                     filter(rownames(.) %in% rownames(res.case_control))

resultsNames(ddsTC)
count.species.case_control.df <- count.species.case_control %>% 
                                 mutate("Species" = rownames(.)) %>%
                                 pivot_longer(cols = CELIAC:CONTROL,
                                              names_to = "Disease_type", 
                                              values_to = "count")



```




                                                              ###########################################
                                                              # GLMER on preseces and absense of virus  #
                                                              ###########################################


################
#    Family    #
################
```{r}

family.name <- colnames(PA.table.family.all)[26:38]
new.family.name <- gsub("/|-","_",family.name)
colnames(PA.table.family.all)[26:38] <- new.family.name


for (i in new.family.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
                  HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                  Age.at.Solid.Introduction..months. + (1 | patientID), 
                  family = binomial(link = "logit"),
                           data = PA.table.family.all)
  
  fit.glance <- glance(glm.fit)

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/genus/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/family/",i,"_glmer_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


```



################
#    Genus     #
################
```{r}
library(GLMMadaptive)

genus.name <- colnames(PA.table.genus.all)[26:77]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(PA.table.genus.all)[26:77] <- new.genus.name



for (i in new.genus.name) {
  
  if (sum(PA.table.genus.all[i]) == 1){
    print(paste0(i," exists in only one sample"))
  }else if(sum(PA.table.genus.all[i]) == 0){
    print(paste0(i," exists in no sample"))
  }else{
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    
    # glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    #               HLA.Category + feeding_first_year + as.numeric(Age.at.Gluten.Introduction..months.) + 
    #               as.numeric(Age.at.Solid.Introduction..months.) + (1 | patientID), 
    #               family = binomial(link = "logit"),
    #                        data = PA.table.genus.all)
    
    glm.fit <- glmer(get(i) ~ Dx.Status : month + Country + Sex + Delivery.Mode + 
               HLA.Category + feeding_first_year + as.numeric(Age.at.Gluten.Introduction..months.) + 
               as.numeric(Age.at.Solid.Introduction..months.) + (1|patientID), 
               family = binomial(link = "logit"),
               data = PA.table.genus.all)
  
  fit.glance <- glance(glm.fit)

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/genus/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/genus/",i,"_glmer_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)|grepl("Response is constant", e$message)|grepl("pwrssUpdate did not converge in (maxit) iterations",e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}

}


df <-PA.table.genus.all %>% dplyr::select(Row.names,26:77) %>% column_to_rownames("Row.names")

ggplot(PA.table.genus.all %>% dplyr::select(Row.names,26:77) %>% column_to_rownames("Row.names"),aes(x = c(26:77),y=Row.names))

PA.table.genus.all$Row.names

```



################
#    Species   #
################
```{r}

species.name <- colnames(PA.table.species.all)[26:317]
new.species.name <- gsub("/|-","_",species.name)
colnames(PA.table.species.all)[26:317] <- new.species.name



for (i in new.species.name) {
  
  if (sum(PA.table.species.all[i]) == 1){
    print(paste0(i," exists in only one sample"))
  }else if(sum(PA.table.species.all[i]) == 2){
    print(paste0(i," exists in only two sample"))
  }else if(sum(PA.table.species.all[i]) == 0){
    print(paste0(i," exists in no sample"))
  }else{
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    
    # glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    #               HLA.Category + feeding_first_year + as.numeric(Age.at.Gluten.Introduction..months.) + 
    #               as.numeric(Age.at.Solid.Introduction..months.) + (1 | patientID), 
    #               family = binomial(link = "logit"),
    #                        data = PA.table.genus.all)
    
    glm.fit <- glmer(get(i) ~ Dx.Status : month + Country + Sex + Delivery.Mode + 
               HLA.Category + feeding_first_year + as.numeric(Age.at.Gluten.Introduction..months.) + 
               as.numeric(Age.at.Solid.Introduction..months.) + (1|patientID), 
               family = binomial(link = "logit"),
               data = PA.table.species.all)
    
    print(paste0("test: ",i))
  
  fit.glance <- glance(glm.fit)
    
    print(paste0("test fit.glance: pass"))

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)
   print(paste0("test fit.tidy: pass"))

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/species/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
  
  print(paste0("test glmer.stats.df: pass"))
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
  
  print(paste0("test glmer.stats.plot: pass"))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
  
   print(paste0("test p: pass"))
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/species/",i,"_glmer.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)|grepl("Response is constant", e$message)|grepl("pwrssUpdate did not converge in (maxit) iterations",e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}

}


df <-PA.table.species.all %>% dplyr::select(Row.names,26:77) %>% column_to_rownames("Row.names")

ggplot(PA.table.species.all %>% dplyr::select(Row.names,26:77) %>% column_to_rownames("Row.names"),aes(x = c(26:77),y=Row.names))

PA.table.species.all$Row.names



```




                                                                  #########################################
                                                                  # Cox PH moel for survival analysis     #
                                                                  #                                       #
                                                                  #########################################


################
#    Species   #
################
```{r}


species.name <- colnames(PA.table.species.all.prev)[26:81]
new.species.name <- gsub("/|-","_",species.name)
colnames(PA.table.species.all.prev)[26:81] <- new.species.name
PA.table.species.all.prev <- PA.table.species.all.prev %>% mutate(across(starts_with("Viruses"), ~ factor(., levels = c(0, 1))))


PA.table.species.all.prev$Dx.Status <- as.numeric(ifelse(PA.table.species.all.prev$Dx.Status == "CONTROL",0,1))
table(PA.table.species.all.prev %>%  distinct(patientID,.keep_all = TRUE) %>% pull(Dx.Status))
#  0  1 
# 36 36 


species.stats.list <- list()

for (i in new.species.name) {
  result <- tryCatch({
    
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months., data = PA.table.species.all.prev)


    fit.tidy <- tidy(cox.fit)

   # write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/grand_final/species/",i,"_cox.csv"))
    
    
    
    # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = exp(cox_summary$coefficients[, 1]),    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 2],                # Standard errors
      z_value = cox_summary$coefficients[, 3],           # Z-values
      p_value = cox_summary$coefficients[, 4],           # P-values
      ci_lower = exp(cox_summary$conf.int[, 3]),        # Lower bound of 95% CI for HR
      ci_upper = exp(cox_summary$conf.int[, 4])         # Upper bound of 95% CI for HR
    )
    
    
    #write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/grand_final/species/",i,"_cox_fill_stats.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == rownames(data.frame(summary(cox.fit)$coefficients))[1]) %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     species.stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


 
species.cox.res <- bind_rows(species.stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"< 0.05","> 0.05")) %>%
                   mutate(`P-adjust` = p.adjust(`Pr...z..`)) %>%
                   mutate(`P-adjust-sig` = ifelse(`P-adjust` < 0.05,"< 0.05","> 0.05")) %>%
                   mutate("taxa_species" = unlist(lapply(strsplit(taxa,";"),"[",7))) %>%
                   mutate("taxa_genus" = unlist(lapply(strsplit(taxa,";"),"[",6))) %>%
                   mutate("taxa_family" = unlist(lapply(strsplit(taxa,";"),"[",5))) %>%
                   mutate("taxa_genus_species" = paste0(unlist(lapply(strsplit(taxa,";"),"[",6)),"_",unlist(lapply(strsplit(taxa,";"),"[",7)))) %>%
                   mutate(taxa_species = gsub("_","-",taxa_species))


write.csv(species.cox.res %>% filter(`Pr...z..` < 0.05),"~/Handley Lab Dropbox/16S/Celiac/plot/COX/grand_final/species_cox_res_p_sig.csv",sep = "\t")


p.species.stats <- ggplot(species.cox.res,aes(x = `exp.coef.`,y=taxa_species,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("< 0.05" = "red", "> 0.05" = "black")) +
  geom_text_repel(data = subset(species.cox.res, `Pr...z..` < 0.05),aes(label = format(round(`Pr...z..`,3),nsmall = 2)),show.legend = FALSE) + #, aes(label = `P-adjust`)
  theme(axis.text.y = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 12,face = "bold")) +
  labs(x = "exp(Coef)",y = "") +
  theme_bw()


 
ggsave(p.species.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/grand_final/species/species.cox.res.pdf",width = 10, height = 15,dpi=600)


species_to_genus <- unlist(split(species.cox.res$taxa_genus,species.cox.res$taxa_species))

library(scales) 

custom_trans <- trans_new(
  name = "custom",
  transform = function(x) {
    # Piecewise transformation
    ifelse(x < 0.05, x * 20,  # Map 0.00-0.05 to 0-1
           ifelse(x < 0.25, (x - 0.05) * 5 + 1,  # Map 0.05-0.25 to 1-2
                  (x - 0.25) * 1 + 2))  # Map 0.25+ proportionally
  },
  inverse = function(x) {
    # Reverse the transformation
    ifelse(x < 1, x / 20,  # Map 0-1 back to 0.00-0.05
           ifelse(x < 2, (x - 1) / 5 + 0.05,  # Map 1-2 back to 0.05-0.25
                  (x - 2) / 1 + 0.25))  # Map 2+ back to 0.25+
  }
)


p.species.stats.Pvalue <- ggplot(species.cox.res %>% filter(`Pr...z..` < 0.25),aes(x = `Pr...z..`,y=reorder(taxa_species, -`Pr...z..`),color = taxa_family)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0.05,linetype="dotted") +
  scale_color_manual(breaks = rev(unique(species.cox.res %>% filter(`Pr...z..` < 0.25) %>% pull(taxa_family))),values = c("#FF5733","#33FF57","#3357FF","#FF33A1","#FFFF33","#FF33FF","#DFFF00","#ab2be2","#FF6347","#FF8C00"), #"#33FFFF",
                     labels = rev(unique(unique(species.cox.res %>% filter(`Pr...z..` < 0.25) %>% pull(taxa_family))))) +  #values = c("< 0.05" = "red", "> 0.05" = "black")
  #geom_text_repel(data = subset(species.cox.res, `Pr...z..` < 0.05),aes(label = format(round(`Pr...z..`,3),nsmall = 2)),show.legend = FALSE) + #, aes(label = `P-adjust`)
  theme(axis.text.y = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 12,face = "bold")) +
  labs(x = "",y = "",color = "Family") + 
  scale_y_discrete(labels = species_to_genus) +
  scale_x_continuous(
    trans = custom_trans,  # Apply the custom transformation
    breaks = c(0.00, 0.05, 0.10, 0.15, 0.20, 0.25),  # Specify breaks
    labels = c("0.00", "0.05", "0.10", "0.15", "0.20", "0.25")  # Specify labels
  ) +
  theme_bw()


ggsave(p.species.stats.Pvalue,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/grand_final/species/species.cox.res.pValue.genusName.update.pdf",width = 8, height = 6,dpi=600)

 
sig.species.adjust <- species.cox.res %>% 
                    filter(`Pr...z..` < 0.05) %>%
                    pull(taxa)

 
 PA.table.species.all.prev <- PA.table.species.all.prev %>% mutate(across(starts_with("Viruses"), ~ as.numeric(as.character(.))))

 
 PA.table.sig.adjust <- PA.table.species.all.prev %>%
                  dplyr::select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(sig.species.adjust)) %>%
                  pivot_longer(cols = starts_with("Viruses"),
                               names_to = "Species", 
                               values_to = "Count") %>%
                  group_by(month,Dx.Status,Species) %>%
                  mutate(total_count = sum(Count))
 


 PA.table.sig.adjust$Species <- lapply(strsplit(PA.table.sig.adjust$Species,";"),function(x) paste0(x[5],";",x[6],";",x[7]))

 
 
 PA.table.sig.adjust$Dx.Status <- ifelse(PA.table.sig.adjust$Dx.Status == 0,"CONTROL","CELIAC")
sig_Species_PA.heatmap.adjust <- ggplot(PA.table.sig.adjust, aes(x = as.character(Species), y = as.character(month), fill = total_count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = total_count), color = "white", size = 3) + 
  facet_wrap(~Dx.Status) +
  labs(title = "PA numbers",
       x = "Groups", y = "Timepoints", fill = "total_PA") +
  theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(sig_Species_PA.heatmap.adjust,file ="~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_prev/Species_PA.heatmap.pdf",width = 15,height = 15)



# check1 <- PA.table.species.all.prev %>% dplyr::select(patientID,Dx.Status,month,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Gammatorquevirus;Torque teno midi virus 8`) %>%
#   dplyr::rename("Torque_teno_midi_virus8" = "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Gammatorquevirus;Torque teno midi virus 8")
#
#
# check.anello2.PA.number <- ggplot(check1,aes(x = patientID,y =as.character(month),fill = Torque_teno_midi_virus8)) +
#   geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
#   #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
#   scale_fill_gradient(low="white", high="black") +
#   geom_text(aes(label =Torque_teno_midi_virus8), color = "red", size = 3) +
#   facet_wrap(~Dx.Status) +
#   labs(title = "PA numbers",
#        x = "Groups", y = "Timepoints", fill = "total_PA") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
#         axis.text.y = element_text(size=15,face="bold"),
#         strip.text.x = element_text(size = 15, face = "bold"))

# ggsave(check.anello2.PA.number,file = "~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_prev/anello_Torque_teno_midi_virus8_PAcheck.pdf",width = 25,height = 8,dpi = 600)



```


Count the number of patients that had co-infection with both reovirus and astrovirus
```{r}


colnames(PA.table.species.all.prev)[colnames(PA.table.species.all.prev) %like% "High Island virus"]

# "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species"
# "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus"
# "Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus"


co_infection <- PA.table.species.all.prev %>% mutate("Co_infection1" = ifelse(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` == 1 & `Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` == 1,TRUE,FALSE),
                                     "Co_infection2" = ifelse(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` == 1 & `Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` == 1,TRUE,FALSE)) %>%
                select(patientID,Co_infection1,Co_infection2)


# double check

Mamastrovirus_species_patients <- PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` ==1) %>% distinct(patientID,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species`)
# 12

View(PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` ==1) %>% distinct(patientID,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species`))

Human_astrovirus_patients <- PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` ==1) %>% distinct(patientID,month,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`)
# 10

View(PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` ==1) %>% distinct(patientID,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`))

High_Island_virus_patients <- PA.table.species.all.prev %>% filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` ==1) %>% distinct(patientID,Dx.Status,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`)
# 9

View(PA.table.species.all.prev %>% filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` ==1) %>% distinct(patientID,Dx.Status,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`))

intersect(unique(Mamastrovirus_species_patients$patientID),unique(High_Island_virus_patients$patientID))
# "01_GEMM_011"  USA

intersect(unique(Human_astrovirus_patients$patientID),unique(High_Island_virus_patients$patientID))


View(PA.table.species.all.prev %>% filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` ==1) %>% distinct(patientID,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`))

View(PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` ==1) %>% distinct(patientID,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`))


View(PA.table.species.all.prev %>% filter(Dx.Status == 1) %>% distinct(patientID,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`))



# "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species"
# "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus"
# "Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus"


table(PA.table.species.all.prev %>%  distinct(patientID,.keep_all = TRUE) %>% pull(Dx.Status))

View(PA.table.species.all.prev %>% filter(Dx.Status == 1) %>% distinct(patientID,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`))


View(PA.table.species.all.prev %>% filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` == 1) %>% distinct(patientID,month,Dx.Status,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`))


View(PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` == 1) %>% distinct(patientID,month,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`))


View(PA.table.species.all.prev %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` == 1) %>% distinct(patientID,month,Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species`))



```


Count the number of patients with Astrovirus and Reovirus in the US and Italy
```{r}

co_infection_country <- PA.table.species.all.prev %>% mutate("Co_infection1" = ifelse(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` == 1 & `Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` == 1,TRUE,FALSE),
                                     "Co_infection2" = ifelse(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` == 1 & `Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` == 1,TRUE,FALSE)) %>%
                select(patientID,Country,Co_infection1,Co_infection2)


# USA
Mamastrovirus_USA <- PA.table.species.all.prev %>% 
                               filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` ==1) %>% 
                               filter(Country == "USA") %>%
                               distinct(patientID,Country,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species`)
# 9

Human_astrovirus_USA <- PA.table.species.all.prev %>% 
                               filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` ==1) %>% 
                               filter(Country == "USA") %>%
                               distinct(patientID,Country,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`)

# 5

High_Island_virus_USA <- PA.table.species.all.prev %>% 
                         filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` ==1) %>%   
                         filter(Country == "USA") %>%
                         distinct(patientID,Country,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`)

# 4



# Italy
Mamastrovirus_Italy <- PA.table.species.all.prev %>% 
                               filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species` ==1) %>% 
                               filter(Country == "ITALY") %>%
                               distinct(patientID,Country,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;Mamastrovirus;unclassified Mamastrovirus species`)
# 3

Human_astrovirus_Italy <- PA.table.species.all.prev %>% 
                               filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus` ==1) %>% 
                               filter(Country == "ITALY") %>%
                               distinct(patientID,Country,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Human astrovirus`)

# 5

High_Island_virus_Italy <- PA.table.species.all.prev %>% 
                         filter(`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus` ==1) %>%   
                         filter(Country == "ITALY") %>%
                         distinct(patientID,`Viruses;Duplornaviricota;Resentoviricetes;Reovirales;Reoviridae;unclassified Reoviridae genus;High Island virus`)

# 5





```


Remake the heatmap the same as it is above, but replace the species name with the genus name. 
Dont do the analysis at genus level, just reannotate the axis labels at the genus level
```{r}

contigAnnotation.astro <- fread("~/Handley Lab Dropbox/16S/Celiac/plot/contigAnnotations.tsv") %>%
                    filter(family == "Astroviridae")

#"contig_49065" "contig_3567"  "contig_34440" "contig_4647"  "contig_3357"  "contig_8153"  "contig_49047" "contig_43336" "contig_3669" 


contigAnnotation.Reovirus <- fread("~/Handley Lab Dropbox/16S/Celiac/plot/contigAnnotations.tsv") #%>%
                    filter(family %like% "Reo")
# none

```


################
#    Genus     #
################
```{r}

genus.name <- colnames(PA.table.genus.all.prev)[26:53]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(PA.table.genus.all.prev)[26:53] <- new.genus.name
PA.table.genus.all.prev <- PA.table.genus.all.prev %>% mutate(across(starts_with("Viruses"), ~ factor(., levels = c(0, 1))))

PA.table.genus.all.prev$Dx.Status <- as.numeric(ifelse(PA.table.genus.all.prev$Dx.Status == "CONTROL",0,1))




# check1 <- PA.table.genus.all.prev %>% dplyr::select(patientID,Dx.Status,month,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus`) %>%
#   dplyr::rename("Anello" = "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus")
# 
# 
# check.anello.PA.number <- ggplot(check1,aes(x = patientID,y =as.character(month),fill = Anello)) +
#   geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
#   #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
#   scale_fill_gradient(low="white", high="black") +
#   geom_text(aes(label = Anello), color = "red", size = 3) + 
#   facet_wrap(~Dx.Status) +
#   labs(title = "PA numbers",
#        x = "Groups", y = "Timepoints", fill = "total_PA") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
#         axis.text.y = element_text(size=15,face="bold"),
#         strip.text.x = element_text(size = 15, face = "bold"))
# 
# ggsave(check.anello.PA.number,file = "~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/anello_PAcheck.pdf",width = 25,height = 8,dpi = 600)


genus.stats.list <- list()

for (i in new.genus.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month,Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months., data = PA.table.genus.all.prev)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/",i,"_cox.csv"))
    
    
     # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = cox_summary$coefficients[, 2],    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 3],                # Standard errors
      z_value = cox_summary$coefficients[, 4],           # Z-values
      p_value = cox_summary$coefficients[, 5],           # P-values
      ci_lower = summary(cox.fit)$conf.int[,3],        # Lower bound of 95% CI for HR
      ci_upper = summary(cox.fit)$conf.int[,4]         # Upper bound of 95% CI for HR
    )
    
    
    write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/",i,"_cox_fill_stats.csv"))
    
    
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == rownames(data.frame(summary(cox.fit)$coefficients))[1]) %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     genus.stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


genus.cox.res <- bind_rows(genus.stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant")) %>%
                   mutate(`P-adjust` = p.adjust(`Pr...z..`)) %>%
                   mutate(`P-adjust-sig` = ifelse(`P-adjust` < 0.05,"Significant","non-Significant"))


p.genus.stats <- ggplot(genus.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-adjust-sig`)) +
                  geom_point(size = 3) +
                  geom_vline(xintercept = 0,linetype="dotted") +
                  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
                  geom_text_repel(data = subset(genus.cox.res, `P-adjust` < 0.05),aes(label = `P-adjust`)) + #, aes(label = `P-adjust`)
                  theme(axis.text.y = element_text(size = 15, face = "bold"),
                        axis.text.x = element_text(size = 15,face = "bold"))

p.genus.stats

ggsave(p.genus.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/genus.cox.adjust.res.pdf",width = 20, height = 10,dpi=600)


 
sig.genus.adjust <- genus.cox.res %>% 
                    filter(`Pr...z..` < 0.05) %>%
                    pull(taxa)
 
 
 PA.table.genus.all.prev <- PA.table.genus.all.prev %>% mutate(across(starts_with("Viruses"), ~ as.numeric(as.character(.))))
 
 PA.table.sig.adjust <- PA.table.genus.all.prev %>%
                  dplyr::select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(sig.genus.adjust)) %>%
                  pivot_longer(cols = starts_with("Viruses"),
                               names_to = "Genus", 
                               values_to = "Count") %>%
                  group_by(month,Dx.Status,Genus) %>%
                  mutate(total_count = sum(Count))
 


 PA.table.sig.adjust$Genus <- lapply(strsplit(PA.table.sig.adjust$Genus,";"),function(x) paste0(x[5],";",x[6]))

 
 PA.table.sig.adjust$Dx.Status <- ifelse(PA.table.sig.adjust$Dx.Status == 0,"CONTROL","CELIAC")
 
sig_Genus_PA.heatmap.adjust <- ggplot(PA.table.sig.adjust, aes(x = as.character(Genus), y = as.character(month), fill = total_count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = total_count), color = "white", size = 3) + 
  facet_wrap(~Dx.Status) +
  labs(title = "PA numbers",
       x = "Groups", y = "Timepoints", fill = "total_PA") +
  theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(sig_Genus_PA.heatmap.adjust,file ="~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/Genus_PA.heatmap.pdf",width = 8,height = 8)




```



################
#    Family    #
################
```{r}


family.name <- colnames(PA.table.family.all)[26:38]
new.family.name <- gsub("/|-","_",family.name)
colnames(PA.table.family.all)[26:38] <- new.family.name


PA.table.family.all$Dx.Status <- as.numeric(ifelse(PA.table.family.all$Dx.Status == "CONTROL",0,1))



stats.list <- list()

for (i in new.family.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = PA.table.family.all)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/",i,"_cox.csv"))
    
    
     # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = exp(cox_summary$coefficients[, 1]),    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 2],                # Standard errors
      z_value = cox_summary$coefficients[, 3],           # Z-values
      p_value = cox_summary$coefficients[, 4],           # P-values
      ci_lower = exp(cox_summary$conf.int[, 3]),        # Lower bound of 95% CI for HR
      ci_upper = exp(cox_summary$conf.int[, 4])         # Upper bound of 95% CI for HR
    )
    
    
    write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/",i,"_cox_fill_stats.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == "get(i)") %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


family.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))


p.family.stats <- ggplot(family.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(family.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
ggsave(p.family.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/family.cox.res.pdf",width = 15, height = 8,dpi=600)


```








                                                                  ############################################
                                                                  # Cox PH moel for survival analysis        #
                                                                  #       without feeding/solid food/gluton  #
                                                                  ############################################


################
#    Species   #
################
```{r}


species.name <- colnames(PA.table.species.all.prev)[26:81]
new.species.name <- gsub("/|-","_",species.name)
colnames(PA.table.species.all.prev)[26:81] <- new.species.name
PA.table.species.all.prev <- PA.table.species.all.prev %>% mutate(across(starts_with("Viruses"), ~ factor(., levels = c(0, 1))))


PA.table.species.all.prev$Dx.Status <- as.numeric(ifelse(PA.table.species.all.prev$Dx.Status == "CONTROL",0,1))




species.stats.list <- list()

for (i in new.species.name) {
  result <- tryCatch({
    
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category, data = PA.table.species.all.prev)
    # + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_less_variable/",i,"_cox.csv"))
    
    
    
    # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = exp(cox_summary$coefficients[, 1]),    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 2],                # Standard errors
      z_value = cox_summary$coefficients[, 3],           # Z-values
      p_value = cox_summary$coefficients[, 4],           # P-values
      ci_lower = exp(cox_summary$conf.int[, 3]),        # Lower bound of 95% CI for HR
      ci_upper = exp(cox_summary$conf.int[, 4])         # Upper bound of 95% CI for HR
    )
    
    
    write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_less_variable/",i,"_cox_fill_stats.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == rownames(data.frame(summary(cox.fit)$coefficients))[1]) %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     species.stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


 
 
species.cox.res <- bind_rows(species.stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant")) %>%
                   mutate(`P-adjust` = p.adjust(`Pr...z..`)) %>%
                   mutate(`P-adjust-sig` = ifelse(`P-adjust` < 0.05,"Significant","non-Significant"))


p.species.stats <- ggplot(species.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(species.cox.res, `Pr...z..` < 0.05),aes(label = `Pr...z..`)) + #, aes(label = `P-adjust`)
  theme(axis.text.y = element_text(size = 15, face = "bold"),
        axis.text.x = element_text(size = 15,face = "bold"))


 
ggsave(p.species.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_less_variable/species.cox.res.pdf",width = 25, height = 15,dpi=600)


 
sig.species.adjust <- species.cox.res %>% 
                    filter(`Pr...z..` < 0.05) %>%
                    pull(taxa)

 
 PA.table.species.all.prev <- PA.table.species.all.prev %>% mutate(across(starts_with("Viruses"), ~ as.numeric(as.character(.))))

 
 PA.table.sig.adjust <- PA.table.species.all.prev %>%
                  dplyr::select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(sig.species.adjust)) %>%
                  pivot_longer(cols = starts_with("Viruses"),
                               names_to = "Species", 
                               values_to = "Count") %>%
                  group_by(month,Dx.Status,Species) %>%
                  mutate(total_count = sum(Count))
 


 PA.table.sig.adjust$Species <- lapply(strsplit(PA.table.sig.adjust$Species,";"),function(x) paste0(x[5],";",x[6],";",x[7]))

 
 
 PA.table.sig.adjust$Dx.Status <- ifelse(PA.table.sig.adjust$Dx.Status == 0,"CONTROL","CELIAC")
sig_Species_PA.heatmap.adjust <- ggplot(PA.table.sig.adjust, aes(x = as.character(Species), y = as.character(month), fill = total_count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = total_count), color = "white", size = 3) + 
  facet_wrap(~Dx.Status) +
  labs(title = "PA numbers",
       x = "Groups", y = "Timepoints", fill = "total_PA") +
  theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(sig_Species_PA.heatmap.adjust,file ="~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_less_variable/Species_PA.heatmap.pdf",width = 15,height = 15)



# check1 <- PA.table.species.all.prev %>% dplyr::select(patientID,Dx.Status,month,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Gammatorquevirus;Torque teno midi virus 8`) %>%
#   dplyr::rename("Torque_teno_midi_virus8" = "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Gammatorquevirus;Torque teno midi virus 8")
#
#
# check.anello2.PA.number <- ggplot(check1,aes(x = patientID,y =as.character(month),fill = Torque_teno_midi_virus8)) +
#   geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
#   #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
#   scale_fill_gradient(low="white", high="black") +
#   geom_text(aes(label =Torque_teno_midi_virus8), color = "red", size = 3) +
#   facet_wrap(~Dx.Status) +
#   labs(title = "PA numbers",
#        x = "Groups", y = "Timepoints", fill = "total_PA") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
#         axis.text.y = element_text(size=15,face="bold"),
#         strip.text.x = element_text(size = 15, face = "bold"))

# ggsave(check.anello2.PA.number,file = "~/Handley Lab Dropbox/16S/Celiac/plot/COX/species_prev/anello_Torque_teno_midi_virus8_PAcheck.pdf",width = 25,height = 8,dpi = 600)



```



################
#    Genus     #
################
```{r}

genus.name <- colnames(PA.table.genus.all.prev)[26:53]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(PA.table.genus.all.prev)[26:53] <- new.genus.name
PA.table.genus.all.prev <- PA.table.genus.all.prev %>% mutate(across(starts_with("Viruses"), ~ factor(., levels = c(0, 1))))

PA.table.genus.all.prev$Dx.Status <- as.numeric(ifelse(PA.table.genus.all.prev$Dx.Status == "CONTROL",0,1))



# check1 <- PA.table.genus.all.prev %>% dplyr::select(patientID,Dx.Status,month,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus`) %>%
#   dplyr::rename("Anello" = "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus")
# 
# 
# check.anello.PA.number <- ggplot(check1,aes(x = patientID,y =as.character(month),fill = Anello)) +
#   geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
#   #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
#   scale_fill_gradient(low="white", high="black") +
#   geom_text(aes(label = Anello), color = "red", size = 3) + 
#   facet_wrap(~Dx.Status) +
#   labs(title = "PA numbers",
#        x = "Groups", y = "Timepoints", fill = "total_PA") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
#         axis.text.y = element_text(size=15,face="bold"),
#         strip.text.x = element_text(size = 15, face = "bold"))
# 
# ggsave(check.anello.PA.number,file = "~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_prev/anello_PAcheck.pdf",width = 25,height = 8,dpi = 600)


genus.stats.list <- list()

for (i in new.genus.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month,Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months., data = PA.table.genus.all.prev)
    #  + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_less_variable/",i,"_cox.csv"))
    
    
     # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = cox_summary$coefficients[, 2],    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 3],                # Standard errors
      z_value = cox_summary$coefficients[, 4],           # Z-values
      p_value = cox_summary$coefficients[, 5],           # P-values
      ci_lower = summary(cox.fit)$conf.int[,3],        # Lower bound of 95% CI for HR
      ci_upper = summary(cox.fit)$conf.int[,4]         # Upper bound of 95% CI for HR
    )
    
    
    write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_less_variable/",i,"_cox_fill_stats.csv"))
    
    
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == rownames(data.frame(summary(cox.fit)$coefficients))[1]) %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     genus.stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


genus.cox.res <- bind_rows(genus.stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant")) %>%
                   mutate(`P-adjust` = p.adjust(`Pr...z..`)) %>%
                   mutate(`P-adjust-sig` = ifelse(`P-adjust` < 0.05,"Significant","non-Significant"))



p.genus.stats <- ggplot(genus.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
                  geom_point(size = 3) +
                  geom_vline(xintercept = 0,linetype="dotted") +
                  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
                  geom_text_repel(data = subset(genus.cox.res, `Pr...z..` < 0.05),aes(label = `Pr...z..`)) + #, aes(label = `P-adjust`)
                  theme(axis.text.y = element_text(size = 15, face = "bold"),
                        axis.text.x = element_text(size = 15,face = "bold"))

 
ggsave(p.genus.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_less_variable/genus.cox.res.pdf",width = 20, height = 10,dpi=600)


 
 sig.genus.adjust <- genus.cox.res %>% 
                    filter(`Pr...z..` < 0.05) %>%
                    pull(taxa)
 
 
 PA.table.genus.all.prev <- PA.table.genus.all.prev %>% mutate(across(starts_with("Viruses"), ~ as.numeric(as.character(.))))
 
 PA.table.sig.adjust <- PA.table.genus.all.prev %>%
                  dplyr::select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(sig.genus.adjust)) %>%
                  pivot_longer(cols = starts_with("Viruses"),
                               names_to = "Genus", 
                               values_to = "Count") %>%
                  group_by(month,Dx.Status,Genus) %>%
                  mutate(total_count = sum(Count))
 


 PA.table.sig.adjust$Genus <- lapply(strsplit(PA.table.sig.adjust$Genus,";"),function(x) paste0(x[5],";",x[6]))

 
 PA.table.sig.adjust$Dx.Status <- ifelse(PA.table.sig.adjust$Dx.Status == 0,"CONTROL","CELIAC")
 
sig_Genus_PA.heatmap.adjust <- ggplot(PA.table.sig.adjust, aes(x = as.character(Genus), y = as.character(month), fill = total_count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = total_count), color = "white", size = 3) + 
  facet_wrap(~Dx.Status) +
  labs(title = "PA numbers",
       x = "Groups", y = "Timepoints", fill = "total_PA") +
  theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(sig_Genus_PA.heatmap.adjust,file ="~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus_less_variable/Genus_PA.heatmap.pdf",width = 8,height = 8)




```



################
#    Family    #
################
```{r}


family.name <- colnames(PA.table.family.all)[26:38]
new.family.name <- gsub("/|-","_",family.name)
colnames(PA.table.family.all)[26:38] <- new.family.name


PA.table.family.all$Dx.Status <- as.numeric(ifelse(PA.table.family.all$Dx.Status == "CONTROL",0,1))



stats.list <- list()

for (i in new.family.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = PA.table.family.all)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/",i,"_cox.csv"))
    
    
     # Get the summary of the Cox model
    cox_summary <- summary(cox.fit)
    
    # Extract the coefficients, standard errors, z-values, and p-values
    model_df <- data.frame(
      term = rownames(cox_summary$coefficients),         # The names of the coefficients (terms)
      coef = cox_summary$coefficients[, 1],              # Coefficients (estimates)
      exp_coef = exp(cox_summary$coefficients[, 1]),    # Hazard ratios (exp(coef))
      se = cox_summary$coefficients[, 2],                # Standard errors
      z_value = cox_summary$coefficients[, 3],           # Z-values
      p_value = cox_summary$coefficients[, 4],           # P-values
      ci_lower = exp(cox_summary$conf.int[, 3]),        # Lower bound of 95% CI for HR
      ci_upper = exp(cox_summary$conf.int[, 4])         # Upper bound of 95% CI for HR
    )
    
    
    write.csv(model_df,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/",i,"_cox_fill_stats.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == "get(i)") %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


family.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))


p.family.stats <- ggplot(family.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(family.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
ggsave(p.family.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/family.cox.res.pdf",width = 15, height = 8,dpi=600)


```













                                                              #################################################
                                                              #   What taxa are pertantially predecing taxa   #               
                                                              #                                               #
                                                              #################################################

For this analysis, we are using a Joint Modeling of Longitudinal and Survival Data approach. This method allows us to analyze the association between longitudinal viral abundance and time-to-diagnosis (event time).


################
#    Species   #
################
```{r}

species.name <- colnames(PA.table.species.all)[26:317]
new.species.name <- gsub("/|-","_",species.name)
colnames(PA.table.species.all)[26:317] <- new.species.name

PA.table.species.all$Dx.Status <- as.numeric(ifelse(PA.table.species.all$Dx.Status == "CONTROL",0,1))

problem.list <- c("Viruses;Cossaviricota;Papovaviricetes;Sepolyvirales;Polyomaviridae;unclassified Polyomaviridae genus;unclassified Polyomaviridae species","Viruses;Cossaviricota;Papovaviricetes;Zurhausenvirales;Papillomaviridae;unclassified Papillomaviridae genus;Human papillomavirus","Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Chaphamaparvovirus;Ungulate chaphamaparvovirus 1","Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno_associated dependoparvovirus A","Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno_associated virus")

new.species.name <- new.species.name[!new.species.name %in% problem.list]

for (i in new.species.name){
  
     if (sum(PA.table.species.all[i]) == 1){
    print(paste0(i," exists in only one sample"))
  }else if(sum(PA.table.species.all[i]) == 2){
    print(paste0(i," exists in only two sample"))
  }else if(sum(PA.table.species.all[i]) == 3){
    print(paste0(i," exists in only three sample"))
  }else if(sum(PA.table.species.all[i]) == 0){
    print(paste0(i," exists in no sample"))
  }else{
     
     
     print(paste("Processing i =", i))

     df.temp <- PA.table.species.all %>%
           dplyr::select(c(i,"month","Country","Sex","Delivery.Mode","HLA.Category","feeding_first_year","Age.at.Gluten.Introduction..months.","Age.at.Solid.Introduction..months.","patientID","Dx.Status")) %>%
           dplyr::rename("Virus" = i)

     print(df.temp$Virus)
     
     lme_model <- lme(Virus ~ month + Dx.Status + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,random = ~ 1 + month|patientID,control= lmeControl(maxIter = 100, msMaxIter = 100),data = df.temp) 
     
     
     cox.fit <- coxph(Surv(month, Dx.Status) ~ Virus + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months. + cluster(patientID), data = df.temp,x = TRUE,model = TRUE)
     
     
     joint_model <- jm(cox.fit,lme_model,time_var = "month")
    
     
     Longitudinal.res <- data.frame(coef(summary(joint_fit))$Longitudinal)
     
     write.csv(Longitudinal.res,"~/Handley Lab Dropbox/16S/Celiac/plot/Joint/species/",i,"_Longitudinal_joint.csv")
     
     Event.res <- data.frame(coef(summary(joint_fit))$Event)
     
     write.csv(Event.res,"~/Handley Lab Dropbox/16S/Celiac/plot/Joint/species/",i,"_Events_joint.csv")
 
  }
  
}

new.species.name[new.species.name %like% "Picornaviridae"]
new.species.name[new.species.name %like% "Astroviridae"]
new.species.name[new.species.name %like% "Anelloviridae"]
new.species.name[new.species.name %like% "Adenoviridae"]

new.species.name.interest1 <- new.species.name[new.species.name %like% "Picornaviridae"]
new.species.name.interest2 <- new.species.name[new.species.name %like% "Astroviridae"]
new.species.name.interest3 <- new.species.name[new.species.name %like% "Anelloviridae"]
new.species.name.interest4 <- new.species.name[new.species.name %like% "Adenoviridae"]
new.species.name.interest <- c(new.species.name.interest1,new.species.name.interest2,new.species.name.interest3,new.species.name.interest4)



"Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species"

df.temp <- PA.table.species.all %>%
           dplyr::select(c("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species","month","Country","Sex","Delivery.Mode","HLA.Category","feeding_first_year","Age.at.Gluten.Introduction..months.","Age.at.Solid.Introduction..months.","patientID","Dx.Status")) %>%
           dplyr::rename("Virus" = "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species")


lme_model <- lme(Virus ~ month + Dx.Status + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,random = ~ 1 + month|patientID,control= lmeControl(maxIter = 100, msMaxIter = 100),data = df.temp) 
     
     
cox.fit <- coxph(Surv(month, Dx.Status) ~ Virus + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months. + cluster(patientID), data = df.temp,x = TRUE,model = TRUE)
     
     
joint_model <- jm(cox.fit,lme_model,time_var = "month")
traceplot(joint_model)

data.frame(coef(summary(joint_model))$Longitudinal)


summary(joint_model)$Longitudinal


for (i in new.species.name.interest){
  
   if (sum(PA.table.species.all[i]) == 1){
    print(paste0(i," exists in only one sample"))
  }else if(sum(PA.table.species.all[i]) == 2){
    print(paste0(i," exists in only two sample"))
  }else if(sum(PA.table.species.all[i]) == 3){
    print(paste0(i," exists in only three sample"))
  }else if(sum(PA.table.species.all[i]) == 0){
    print(paste0(i," exists in no sample"))
  }else{

  result <- tryCatch({
    
    print(paste("Processing i =", i))

     df.temp <- PA.table.species.all %>%
           dplyr::select(c(i,"month","Country","Sex","Delivery.Mode","HLA.Category","feeding_first_year","Age.at.Gluten.Introduction..months.","Age.at.Solid.Introduction..months.","patientID","Dx.Status")) %>%
           dplyr::rename("Virus" = i)

     print(df.temp$Virus)
     
     
     
     lme_model <- lme(Virus ~ month + Dx.Status + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,random = ~ 1 + month|patientID,control= lmeControl(maxIter = 100, msMaxIter = 100),data = df.temp) 
     
     
     cox.fit <- coxph(Surv(month, Dx.Status) ~ Virus + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months. + cluster(patientID), data = df.temp,x = TRUE,model = TRUE)
     
     
     joint_model <- jm(cox.fit,lme_model,time_var = "month")
     
     survival.res <- data.frame(joint_model$statistics$P$gammas)

     
     write.csv(survival.res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/Joint/species/",i,"_Survival_joint.csv"))
     
     Longitudinal.res <- data.frame(joint_model$statistics$P$betas1)

     
     write.csv(Event.res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/Joint/species/",i,"_Longitudinal_joint.csv"))
     
     
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("nlminb problem, convergence error code = 1", e$message)||grepl("NA/NaN/Inf in 'y'",e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })

}


}




# first we fit the mix-linear model
library(nlme)

lme_model <- lme(`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;unclassified Anelloviridae species` ~ month + Dx.Status + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,random = ~ 1 + month|patientID,data = glm.table.species.all) #random = ~ 1 + month| patientID


# then we fit coxph model
library(survival)

cox.fit <- coxph(Surv(month, Dx.Status) ~ Virus + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months. + cluster(patientID), data = df.temp,x = TRUE,model = TRUE) # +cluster(patientID)



# finally we build the joint model
library(JMbayes2)
# Fit the joint model
joint_model <- jm(cox.fit,lme_model,time_var = "month")
summary(joint_model)



```




##############
#    Genus   #
##############
```{r}


genus.name <- colnames(PA.table.genus.all)[26:77]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(PA.table.genus.all)[26:77] <- new.genus.name

PA.table.genus.all$Dx.Status <- as.numeric(ifelse(PA.table.genus.all$Dx.Status == "CONTROL",0,1))



for (i in new.genus.name){
  
   if (sum(PA.table.genus.all[i]) == 1){
    print(paste0(i," exists in only one sample"))
  }else if(sum(PA.table.genus.all[i]) == 2){
    print(paste0(i," exists in only two sample"))
  }else if(sum(PA.table.genus.all[i]) == 3){
    print(paste0(i," exists in only three sample"))
  }else if(sum(PA.table.genus.all[i]) == 0){
    print(paste0(i," exists in no sample"))
  }else{

  result <- tryCatch({
    
    print(paste("Processing i =", i))

     df.temp <- PA.table.genus.all %>%
           dplyr::select(c(i,"month","Country","Sex","Delivery.Mode","HLA.Category","feeding_first_year","Age.at.Gluten.Introduction..months.","Age.at.Solid.Introduction..months.","patientID","Dx.Status")) %>%
           dplyr::rename("Virus" = i)

     print(df.temp$Virus)
     
     
     
     lme_model <- lme(Dx.Status ~ Virus + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,random = ~ 1 + month|patientID,control= lmeControl(maxIter = 100, msMaxIter = 100),data = df.temp) 
     
     
     cox.fit <- coxph(Surv(month, Dx.Status) ~ Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months. + cluster(patientID), data = df.temp,x = TRUE,model = TRUE)
     
     
     joint_model <- jm(cox.fit,lme_model,time_var = "month")
     
     survival.res <- data.frame(joint_model$statistics$P$gammas)

     
     write.csv(survival.res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/Joint/genus_update/",i,"_Survival_joint.csv"))
     
     Longitudinal.res <- data.frame(joint_model$statistics$P$betas1)

     
     write.csv(Longitudinal.res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/Joint/genus_update/",i,"_Longitudinal_joint.csv"))
     
     
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("nlminb problem, convergence error code = 1", e$message)||grepl("NA/NaN/Inf in 'y'",e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })

}


}




```



###############
#    Family   #
###############
```{r}



```




################
#    Species   #
################
```{r}

# extract the case samples
case_sampels <- metadata.final %>%
                filter(disease_onset_details != "Control") %>%
                pull(sampleName)



case_sampels_changeName <- metadata.final %>%
                           filter(disease_onset_details != "Control")


count.specis.case <- count.species %>%
                     select(all_of(case_sampels))



# find the taxa that are significantly different in case group at each timep point (higher and lower respectively)
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species/"

sig.res.species.table.list <- list.files("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species/",pattern = glob2rx("Disease_statusCELIAC.mont*csv"))
# "Disease_statusCELIAC.month18_sig_species.csv" "Disease_statusCELIAC.month24_sig_species.csv" "Disease_statusCELIAC.month30_sig_species.csv"
# "Disease_statusCELIAC.month36_sig_species.csv" "Disease_statusCELIAC.month48_sig_species.csv" "Disease_statusCELIAC.month54_sig_species.csv"
# "Disease_statusCELIAC.month60_sig_species.csv" "Disease_statusCELIAC.month72_sig_species.csv" "Disease_statusCELIAC.month84_sig_species.csv"



for (i in sig.res.species.table.list){

     sig.taxa <- rownames(read.csv(paste0(file.path,i),row.names = "X"))

     if (length(sig.taxa) == 0){

       next

     }else{
       
     file.name <-lapply(strsplit(i,"[.]"),"[",2)
     month <-  paste0(gsub("month","",lapply(strsplit(file.name[[1]],"_"),"[",1)),"M")

     
     count.specis.case.time <- count.specis.case %>%
                               filter(rownames(.) %in% sig.taxa) %>%
                               select(contains(month))
     

     write.csv(count.specis.case.time,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/",file.name,".csv"))


     

     #get the new column names
     names(count.specis.case.time) <- case_sampels_changeName$disease_onset_details[match(names(count.specis.case.time), case_sampels_changeName$sampleName)]

     final_res <- t(count.specis.case.time) %>%
      data.frame(.) %>%
      rownames_to_column("disease_group") %>%
      mutate(disease_group = ifelse(disease_group %like% "Case_onset","Case_onset",paste0("Case_precede_",month)))%>%
      group_by(disease_group) %>%
      summarise_each(list(sum)) %>%
      column_to_rownames("disease_group") %>%
      t(.) 
     


     write.csv(final_res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/",month,"_final_res.csv"))
     
    }

}


# combine restuls tables
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/"

sig.res.species.final_res.list <- list.files(file.path,pattern = "_final_res")
#"18M_final_res.csv" "24M_final_res.csv" "30M_final_res.csv" "36M_final_res.csv" "48M_final_res.csv" "60M_final_res.csv" "84M_final_res.csv"


for (i in (1:length(sig.res.species.final_res.list))){
  print(i)
  
  final_res.list[[i]] <- read.csv(paste0(file.path,sig.res.species.final_res.list[i])) %>%
                        rename(Case_onset = paste0("Case_onset",i))
  
  
}



# merge them together
final_res.total <- Reduce(function(x, y) merge(x, y,by = "X",  all=TRUE), final_res.list)
final_res.total[is.na(final_res.total)] <- 0
final_res.total <- final_res.total %>%
                   column_to_rownames("X") %>%
                   select(contains("Case_precede"),Case_onset1) %>%
                   rename(Case_onset1 = "Case_onset") %>%
                   mutate(Ratio_precede = select(., Case_precede_18M:Case_precede_60M) %>% 
                                  rowSums(na.rm = TRUE) / rowSums(.))


write.csv(final_res.total,"~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_species_res_total_counts.csv")


final_res.total.heatmap <- final_res.total %>% 
                           select(-Ratio_precede) %>%
                           rownames_to_column("Species") %>%
                            pivot_longer(cols = Case_precede_18M:Case_onset,
                              names_to = "time", 
                              values_to = "count")


final_res.total.heatmap$time <- factor(final_res.total.heatmap$time,levels = c("Case_precede_18M","Case_precede_24M","Case_precede_30M","Case_precede_36M","Case_precede_48M","Case_precede_60M","Case_onset"))


final_res.total.p <- ggplot(final_res.total.heatmap,aes(x = time,y = Species,fill = log10(count))) +
  geom_tile(colour = "white") +
  #geom_text(aes(label = count), color = "white", size = 4) +
  scale_fill_gradient2(low = "white",
                       mid = "gray",
                       high = "black") +
  theme(axis.text = element_text(size = 30)) +
  theme(axis.text.x = element_text(angle = 90))

ggsave(final_res.total.p,file="~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_species_res_total_heatmap.pdf",width = 40, height = 20, dpi = 600)




```
                                                             
