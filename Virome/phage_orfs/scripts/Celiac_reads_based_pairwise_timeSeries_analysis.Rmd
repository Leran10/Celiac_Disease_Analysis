---
title: "Celiac_reads_based_pairwise_timeSeries_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(readxl)
library(broom.mixed)
library(DESeq2)
library(ggrepel)
library(pheatmap)
library(phyloseq)
library(pROC)
library(lme4)
library("survival")
library("survminer")
```


# import metadata and reads table
```{r}

# metadata
metadata.final <- read.csv("~/Handley Lab Dropbox/16S/Celiac/metadata/metadata_final_update_11262024.csv") #%>%
                  # mutate(sampleName = ifelse(sampleName %like% "_6Y",gsub("_6Y","_72M",sampleName),
                  #                          ifelse(sampleName %like% "_7Y",gsub("_7Y","_84M",sampleName),sampleName))) %>%
                  #  mutate(Sample.Name.External.ID = ifelse(Sample.Name.External.ID %like% "_6Y",gsub("_6Y","_72M",Sample.Name.External.ID),
                  #                          ifelse(Sample.Name.External.ID %like% "_7Y",gsub("_7Y","_84M",Sample.Name.External.ID),Sample.Name.External.ID))) %>%
                  #  mutate(Sample_full_name = ifelse(Sample_full_name %like% "_6Y",gsub("_6Y","_72M",Sample_full_name),
                  #                          ifelse(Sample_full_name %like% "_7Y",gsub("_7Y","_84M",Sample_full_name),Sample_full_name)))


# import virus of interest
vv.foi <- as_tibble(fread("~/Handley Lab Dropbox/16S/Celiac/tables/Vertebrate_viruses_strain_counts.tsv",header = TRUE)) %>%
                  mutate(sampleName = ifelse(sampleName %like% "_6Y",gsub("_6Y","_72M",sampleName),
                                           ifelse(sampleName %like% "_7Y",gsub("_7Y","_84M",sampleName),sampleName))) %>%
                   mutate(sampleID = ifelse(sampleID %like% "_6Y",gsub("_6Y","_72M",sampleID),
                                           ifelse(sampleID %like% "_7Y",gsub("_7Y","_84M",sampleID),sampleID))) %>%
                   mutate(sampleID_mod = ifelse(sampleID_mod %like% "_6Y",gsub("_6Y","_72M",sampleID_mod),
                                           ifelse(sampleID_mod %like% "_7Y",gsub("_7Y","_84M",sampleID_mod),sampleID_mod)))

```



                                            ###########################################################################
                                            #   What are the differences between case and control in each timepoint   #               
                                            #                                                                         #
                                            ###########################################################################


#------------------------Species Level-------------------------#


###############################
#  LRT on abundance of virus  #
###############################

# extract count table
```{r}

count.raw <-left_join(metadata.final,vv.foi,by = "sampleName")
count.raw$count[is.na(count.raw$count)] <- 0
count.species <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family","genus","species"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_species = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_species", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")


# OTU = otu_table(count.species, taxa_are_rows = TRUE)
# TAX = tax_table(tax_mat)
# samples = sample_data(metadata.final.deseq)
# 
# ps0.virus.species <-phyloseq(OTU, samples)
# saveRDS(ps0.virus.species,"~/Handley Lab Dropbox/16S/Celiac/ps0.virus.species.rds")


count.genus <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family","genus"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_genus = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_genus", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")




count.family <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_family = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "sum_count_family", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")


```








# time series analysis on pairwise data
# LRT (Likely Ratio Test)
The LRT examines two models for the counts, a full model with a certain number of terms and a reduced model, in which some of the terms of the full model are removed. The test determines if the increased likelihood of the data using the extra terms in the full model is more than expected if those extra terms are truly zero.
comparing the differences between case and control data at each timepoint.
```{r}

# modify metadata table for deseq analysis
metadata.final.deseq <- metadata.final %>%
                        column_to_rownames("sampleName") %>%
                        dplyr::rename("Disease_status" = "Dx.Status") %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")
dim(metadata.final.deseq)
# 298  24


# trim the samples in count.species table to consistent with the metadata table
count.species.deseq <- count.species %>%
                       select(rownames(metadata.final.deseq))

dim(count.species.deseq)
# 292 298


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.deseq <- metadata.final.deseq[colnames(count.species.deseq),]
# 298  24
                    

# make the month variable factor
metadata.final.deseq$month <- factor(metadata.final.deseq$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
metadata.final.deseq$Disease_status <- factor(metadata.final.deseq$Disease_status,levels = c("CONTROL","CELIAC"))
metadata.final.deseq$Age.at.Gluten.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Gluten.Introduction..months.)
metadata.final.deseq$Age.at.Solid.Introduction..months. <- as.numeric(metadata.final.deseq$Age.at.Solid.Introduction..months.)

rownames(count.species.deseq) <- gsub("/","_",rownames(count.species.deseq))


# NOTE: since some counts are supper big (max:2286983738). And these values will become NA in the process of DESeqDataSetFromMatrix().
# One way is to scale the entire data by 2, that is divide the entire count table by 2, and round it up.
# reference: https://chat.stackoverflow.com/rooms/223701/discussion-between-stupidwolf-and-jack-henry

count.species.deseq.scale <- round(count.species.deseq /2)

# design the model
ddsTC <- DESeqDataSetFromMatrix(countData = count.species.deseq.scale + 1,
                                colData = metadata.final.deseq,
                                design = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month + feeding_first_year + as.numeric(Age.at.Solid.Introduction..months.) + as.numeric(Age.at.Gluten.Introduction..months.) + Disease_status:month)  # Disease_status + month + 



table(metadata.final.deseq$feeding_first_year)
# Breast_fed       Breastmilk_and_formula                Formula 
#        119                    124                        55

table(metadata.final.deseq$Country)
# ITALY   USA 
#   101   197 

table(metadata.final.deseq$Sex)
# Female   Male 
#    231     67

table(metadata.final.deseq$Age.at.Solid.Introduction..months.)
 #  4   5   6   7   8  10 
 # 37  80 118  57   5   1 



table(metadata.final.deseq$Delivery.Mode)
# C-Section   Vaginal 
#        84       214 


table(metadata.final.deseq$HLA.Category)
    # High Risk   Low/No Risk Standard Risk 
    #        86            48           164 


# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
ddsTC <- DESeq(ddsTC, test="LRT", reduced = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month + feeding_first_year + as.numeric(Age.at.Solid.Introduction..months.) + as.numeric(Age.at.Gluten.Introduction..months.))



# check the result of analysis
resTC <- results(ddsTC)

# extract the result table
res.table <- resTC[order(resTC$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)


resultsNames(ddsTC)
# [1] "Intercept"                                               "Country_USA_vs_ITALY"                                   
#  [3] "Sex_Male_vs_Female"                                      "Delivery.Mode_Vaginal_vs_C.Section"                     
#  [5] "HLA.Category_Low.No.Risk_vs_High.Risk"                   "HLA.Category_Standard.Risk_vs_High.Risk"                
#  [7] "Disease_status_CELIAC_vs_CONTROL"                        "month_18_vs_12"                                         
#  [9] "month_24_vs_12"                                          "month_30_vs_12"                                         
# [11] "month_36_vs_12"                                          "month_48_vs_12"                                         
# [13] "month_54_vs_12"                                          "month_60_vs_12"                                         
# [15] "month_72_vs_12"                                          "month_84_vs_12"                                         
# [17] "feeding_first_year_Breastmilk_and_formula_vs_Breast_fed" "feeding_first_year_Formula_vs_Breast_fed"               
# [19] "as.numeric.Age.at.Solid.Introduction..months.."          "as.numeric.Age.at.Gluten.Introduction..months.."        
# [21] "Disease_statusCELIAC.month18"                            "Disease_statusCELIAC.month24"                           
# [23] "Disease_statusCELIAC.month30"                            "Disease_statusCELIAC.month36"                           
# [25] "Disease_statusCELIAC.month48"                            "Disease_statusCELIAC.month54"                           
# [27] "Disease_statusCELIAC.month60"                            "Disease_statusCELIAC.month72"                           
# [29] "Disease_statusCELIAC.month84"          



for (i in resultsNames(ddsTC)[2:29]){
  
    res.case_control <- results(ddsTC, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    print(dim(res.case_control))
    
    write.csv(res.case_control,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species_moreVariable/",i,"_sig_species.csv"))
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
        
        df <- res.case_control %>% filter(rownames(res.case_control) == j)
        
        padj <- df %>% pull(padj)
        stats <- df %>% pull(log2FoldChange)
        
        count.plot <- plotCounts(ddsTC, j,
                   intgroup = c("month","Disease_status"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Disease_status <- factor(count.plot$Disease_status,levels = c("CONTROL","CELIAC"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Disease_status, group = Disease_status)) + 
                geom_jitter(width = 0.3) + 
                scale_color_manual(breaks = c("CONTROL","CELIAC"), 
                       values=c("#09bc8a","#d81e5b")) +  
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species_moreVariable/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


res.case_control.list <- list()

ddsResNames <- resultsNames(ddsTC)[2:29]


for (i in (1:length(ddsResNames))){
  
     df <- results(ddsTC, name=ddsResNames[i], test="Wald") %>%
                                      data.frame(.) %>%
                                      filter(padj < 0.05) %>%
                                      select(log2FoldChange) #%>% 
     
     colnames(df) <- ddsResNames[i]
     
     df <- df %>%
           rownames_to_column("rowname")
   
      
      res.case_control.list[[i]] <-  df


}



res.case_control.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.case_control.list)
res.case_control.total[is.na(res.case_control.total)] <- 0
res.case_control.total <- res.case_control.total %>%
                          column_to_rownames("rowname")



thr <- 7
res.case_control.total[res.case_control.total < -thr] <- -thr
res.case_control.total[res.case_control.total > thr] <- thr


ggsave(pheatmap(res.case_control.total, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 25,fontsize_col = 25),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/sig.species.heatmap.moreVariable.pdf",width = 40, height = 30, dpi=600)





# extract the rellevant comparisons and viruses and remake the heatmap
res.case_control.total.relevant <- res.case_control.total %>%
                                   select("Disease_statusCELIAC.month18","Disease_statusCELIAC.month24","Disease_statusCELIAC.month30","Disease_statusCELIAC.month36","Disease_statusCELIAC.month48","Disease_statusCELIAC.month54","Disease_statusCELIAC.month60","Disease_statusCELIAC.month72","Disease_statusCELIAC.month84") %>%
  filter(rownames(.) %in% c("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Caliciviridae;unclassified Caliciviridae genus;unclassified Caliciviridae species",
                            "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus",
                            "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Human mastadenovirus C",
                            "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Torque teno virus",
                            "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;unclassified Anelloviridae species",
                            "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;unclassified Picornavirales family;unclassified Picornavirales genus;unclassified Picornavirales species",
                           "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus;Torque teno mini virus 8",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Primate bocaparvovirus 1",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Bocaparvovirus sp.",
                           "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Bocaparvovirus;Bocavirus PgBoV-1"))
                                   


thr <- 7
res.case_control.total.relevant[res.case_control.total.relevant < -thr] <- -thr
res.case_control.total.relevant[res.case_control.total.relevant > thr] <- thr


ggsave(pheatmap(res.case_control.total.relevant, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 25,fontsize_col = 25),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/sig.species.heatmap.relevant.pdf",width = 40, height = 15, dpi=600)



# boxplot for celiac vs control groups
count.species.case_control <- count.species
match(metadata.final[,"sampleName"], names(count.species.case_control))
names(count.species.case_control)[match(metadata.final[,"sampleName"], names(count.species.case_control))] = metadata.final[,"Dx.Status"]


res.case_control <- results(ddsTC, name="Disease_status_CELIAC_vs_CONTROL", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)


count.species.case_control.sig.df <- count.species.case_control %>%
                                     filter(rownames(.) %in% rownames(res.case_control))

resultsNames(ddsTC)
count.species.case_control.df <- count.species.case_control %>% 
                                 mutate("Species" = rownames(.)) %>%
                                 pivot_longer(cols = CELIAC:CONTROL,
                                              names_to = "Disease_type", 
                                              values_to = "count")



```


####################################
#  prepare species abundance table #
####################################

```{r}

# create species abundance table
count.species.abundance <- count.species

# merge count table and metadata table
abundance.table.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.abundance),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



abundance.table.all$month <- factor(abundance.table.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
abundance.table.all$Dx.Status <- factor(abundance.table.all$Dx.Status,levels = c("CONTROL","CELIAC"))



# create genus abundance table
count.genus.abundance <- count.genus

# merge count table and metadata table
abundance.table.all.genus <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.abundance),by = 0) %>%
                            filter(feeding_first_year != "Unknown") %>%
                            filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                            filter(Age.at.Gluten.Introduction..months. != "Unknown")



abundance.table.all.genus$month <- factor(abundance.table.all.genus$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
abundance.table.all.genus$Dx.Status <- factor(abundance.table.all.genus$Dx.Status,levels = c("CONTROL","CELIAC"))


```




###########################################
# GLMER on preseces and absense of virus  #
###########################################


# glmer table preparation
```{r}

# ---------------------------------------- create species glm table--------------------------------------------#
count.species.glm <- count.species
count.species.glm[count.species.glm != 0] <- 1


# merge count table and metadata table
glm.table.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



# glm.table.all$month <- factor(glm.table.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
# glm.table.all$Dx.Status <- factor(glm.table.all$Dx.Status,levels = c("CONTROL","CELIAC"))



# ---------------------------------------- create genus glm table--------------------------------------------#
count.genus.glm <- count.genus
count.genus.glm[count.genus.glm != 0] <- 1


# merge count table and metadata table
glm.table.genus.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



# glm.table.genus.all$month <- factor(glm.table.genus.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
# glm.table.genus.all$Dx.Status <- factor(glm.table.genus.all$Dx.Status,levels = c("CONTROL","CELIAC"))




# ---------------------------------------- create family glm table--------------------------------------------#
count.family.glm <- count.family
count.family.glm[count.family.glm != 0] <- 1


# merge count table and metadata table
glm.table.family.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.family.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



# glm.table.family.all$month <- factor(glm.table.family.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
# glm.table.family.all$Dx.Status <- factor(glm.table.family.all$Dx.Status,levels = c("CONTROL","CELIAC"))


```



# Species level GLMER models
```{r}

rownames(count.species.deseq) <- gsub("/","_",rownames(count.species.deseq))

species.name <- colnames(glm.table.all)[26:317]
name.species.name <- gsub("/|-","_",species.name)
colnames(glm.table.all)[26:317] <- name.species.name



for (i in name.species.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
                  HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                  Age.at.Solid.Introduction..months. + (1 | patientID), 
                  family = binomial(link = "logit"),
                           data = glm.table.all)
  
  fit.glance <- glance(glm.fit)

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/species/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/species/",i,"_glmer_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


```


# Genus level GLMER models
```{r}

genus.name <- colnames(glm.table.genus.all)[26:77]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(glm.table.genus.all)[26:77] <- new.genus.name





for (i in new.genus.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
                  HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                  Age.at.Solid.Introduction..months. + (1 | patientID), 
                  family = binomial(link = "logit"),
                           data = glm.table.genus.all)
  
  fit.glance <- glance(glm.fit)

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/genus/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/genus/",i,"_glmer_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


```


# Family level GLMER models
```{r}

family.name <- colnames(glm.table.family.all)[26:38]
new.family.name <- gsub("/|-","_",family.name)
colnames(glm.table.family.all)[26:38] <- new.family.name


for (i in new.family.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    glm.fit <- glmer(get(i) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
                  HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                  Age.at.Solid.Introduction..months. + (1 | patientID), 
                  family = binomial(link = "logit"),
                           data = glm.table.family.all)
  
  fit.glance <- glance(glm.fit)

  fit.tidy <- tidy(glm.fit) %>%
              add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

  write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/family/",i,"_glmer.csv"))
     
     
     
  glmer.stats.df <- tidy(glm.fit, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
  glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
  glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
  p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = paste0("GLMER Model for",i))+
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/GLMER/family/",i,"_glmer_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


```



# fishers' exact test - Astrovirus
```{r}

# Fit a logistic regression model
Astrovirus.glm <- glmer(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
    Age.at.Solid.Introduction..months. + (1 | patientID), 
    family = binomial(link = "logit"),
             data = glm.table.all)

View(glm.table.all %>% select(Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus`,month) %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` == 1))


View(predece.table.all %>% select(Dx.Status,`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus`,month) %>% filter(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` != 0))


summary(Astrovirus.glm)
#      AIC      BIC   logLik deviance df.resid 
#    101.3    256.6     -8.7     17.3      256 
# 
# Scaled residuals: 
#    Min     1Q Median     3Q    Max 
# -1.000  0.000  0.000  0.000  1.732 
# 
# Random effects:
#  Groups    Name        Variance  Std.Dev. 
#  patientID (Intercept) 3.706e-16 1.925e-08
# Number of obs: 298, groups:  patientID, 61
# 
# 
# Fixed effects:
#                                            Estimate Std. Error z value Pr(>|z|)
# (Intercept)                               5.681e+00  2.217e+05   0.000    1.000
# Dx.StatusCELIAC                           7.721e-08  2.251e+00   0.000    1.000
# month18                                  -1.301e-09  1.789e+00   0.000    1.000
# month24                                   1.099e+00  2.033e+00   0.540    0.589
# month30                                  -2.052e+01  3.500e+04  -0.001    1.000
# month36                                  -2.120e+01  1.686e+07   0.000    1.000
# month48                                  -2.266e+01  1.742e+07   0.000    1.000
# month54                                   3.572e+00  4.783e+06   0.000    1.000
# month60                                  -1.289e+01  2.432e+07   0.000    1.000
# month72                                   2.789e+01  1.295e+07   0.000    1.000
# month84                                   1.571e+01  4.896e+07   0.000    1.000
# CountryUSA                               -8.326e+01  6.885e+06   0.000    1.000
# SexMale                                  -5.078e+00  4.422e+04   0.000    1.000
# Delivery.ModeVaginal                     -8.162e+00  3.216e+04   0.000    1.000
# HLA.CategoryLow/No Risk                  -2.885e+01  1.241e+07   0.000    1.000
# HLA.CategoryStandard Risk                -1.204e+01  4.588e+04   0.000    1.000
# feeding_first_yearBreastmilk_and_formula -2.076e+01  2.459e+04  -0.001    0.999
# feeding_first_yearFormula                -1.313e+01  4.331e+04   0.000    1.000
# Age.at.Gluten.Introduction..months.11    -2.304e+01  1.224e+07   0.000    1.000
# Age.at.Gluten.Introduction..months.15     3.958e+01  8.010e+06   0.000    1.000
# Age.at.Gluten.Introduction..months.36     3.962e+01  2.644e+07   0.000    1.000
# Age.at.Gluten.Introduction..months.4     -3.210e+01  3.281e+07   0.000    1.000
# Age.at.Gluten.Introduction..months.5      6.987e+01  7.076e+06   0.000    1.000
# Age.at.Gluten.Introduction..months.6     -4.852e+01  1.089e+07   0.000    1.000
# Age.at.Gluten.Introduction..months.7     -2.574e+01  8.266e+04   0.000    1.000
# Age.at.Gluten.Introduction..months.8     -1.141e+01  8.477e+04   0.000    1.000
# Age.at.Gluten.Introduction..months.9      7.778e+00  1.946e+05   0.000    1.000
# Age.at.Solid.Introduction..months.4       1.473e+01  1.221e+07   0.000    1.000
# Age.at.Solid.Introduction..months.5       1.934e+01  2.914e+05   0.000    1.000
# Age.at.Solid.Introduction..months.6       3.100e+01  2.311e+05   0.000    1.000
# Age.at.Solid.Introduction..months.7       1.777e+01  2.322e+05   0.000    1.000
# Age.at.Solid.Introduction..months.8      -4.783e+01  3.059e+07   0.000    1.000
# Dx.StatusCELIAC:month18                  -4.247e+01  1.365e+07   0.000    1.000
# Dx.StatusCELIAC:month24                  -4.571e+01  1.576e+07   0.000    1.000
# Dx.StatusCELIAC:month30                   2.052e+01  3.500e+04   0.001    1.000
# Dx.StatusCELIAC:month36                  -3.458e+01  2.333e+07   0.000    1.000
# Dx.StatusCELIAC:month48                  -2.287e+01  2.397e+07   0.000    1.000
# Dx.StatusCELIAC:month54                  -1.088e-01  5.429e+07   0.000    1.000
# Dx.StatusCELIAC:month60                  -1.738e+01  2.505e+07   0.000    1.000
# Dx.StatusCELIAC:month72                   4.212e+00  5.133e+07   0.000    1.000
# Dx.StatusCELIAC:month84                   2.637e+01  5.911e+07   0.000    1.000



glmer.Astro.stats.df <- tidy(Astrovirus.glm, conf.int = TRUE, exponentiate = TRUE) %>%
  filter(effect == "fixed")

glmer.Astro.stats.df$stars <- cut(glmer.Astro.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)

glmer.Astro.stats.plot <- glmer.Astro.stats.df %>%
  mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))

p.astro <- ggplot(glmer.Astro.stats.plot, aes(y = term, x = estimate, 
                        xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
  geom_text(aes(label = sig), color = ifelse(glmer.Astro.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
  geom_pointrange(position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
  scale_x_log10(limits = c(0.001, 10000), 
                breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
  labs(x = "Odds Ratio (log scale)", 
       y = "", 
       title = "Prediction of Astrovirus Presence in Case") +
  theme(legend.position = "none") +
  scale_color_identity()

ggsave(p.astro,file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/PA_plots_species/glmer.astro.pdf",width = 15, height = 15, dpi = 600)



```



# fishers' exact test - Enterovirus
```{r}

# Fit a logistic regression model
enterovirus.glm <- glmer(`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus` ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
    Age.at.Solid.Introduction..months. + (1 | patientID), 
    family = binomial(link = "logit"),
             data = glm.table.all)


summary(enterovirus.glm)
# Fixed effects:
#                                            Estimate Std. Error z value Pr(>|z|)  
# (Intercept)                              -2.142e+01  1.312e+05   0.000   0.9999  
# Dx.StatusCELIAC                          -1.125e+00  1.294e+00  -0.869   0.3847  
# month18                                  -8.245e-01  1.329e+00  -0.621   0.5349  
# month24                                   1.055e+00  1.101e+00   0.958   0.3381  
# month30                                   9.261e-01  1.219e+00   0.760   0.4474  
# month36                                   6.379e-01  1.493e+00   0.427   0.6692  
# month48                                  -2.009e+01  2.787e+04  -0.001   0.9994  
# month54                                  -2.029e+01  6.711e+07   0.000   1.0000  
# month60                                  -2.833e+01  1.927e+06   0.000   1.0000  
# month72                                  -3.304e+01  3.327e+07   0.000   1.0000  
# month84                                  -3.762e+01  4.745e+07   0.000   1.0000  
# CountryUSA                                2.087e+01  1.431e+04   0.001   0.9988  
# SexMale                                   6.853e-01  1.089e+00   0.629   0.5292  
# Delivery.ModeVaginal                     -2.223e+01  1.431e+04  -0.002   0.9988  
# HLA.CategoryLow/No Risk                  -2.242e+01  1.431e+04  -0.002   0.9987  
# HLA.CategoryStandard Risk                -1.301e+00  1.101e+00  -1.181   0.2376  
# feeding_first_yearBreastmilk_and_formula  2.012e-01  1.032e+00   0.195   0.8454  
# feeding_first_yearFormula                -1.538e+00  1.174e+00  -1.310   0.1901  
# Age.at.Gluten.Introduction..months.11    -3.023e+01  1.663e+06   0.000   1.0000  
# Age.at.Gluten.Introduction..months.15    -3.021e+01  7.660e+05   0.000   1.0000  
# Age.at.Gluten.Introduction..months.36    -1.701e+01  2.303e+07   0.000   1.0000  
# Age.at.Gluten.Introduction..months.4     -3.176e+01  3.334e+06   0.000   1.0000  
# Age.at.Gluten.Introduction..months.5     -3.444e+01  1.528e+07   0.000   1.0000  
# Age.at.Gluten.Introduction..months.6     -6.550e-01  1.705e+00  -0.384   0.7009  
# Age.at.Gluten.Introduction..months.7     -2.341e+00  1.400e+00  -1.672   0.0944 .
# Age.at.Gluten.Introduction..months.8     -2.944e+01  5.131e+05   0.000   1.0000  
# Age.at.Gluten.Introduction..months.9      6.506e-01  1.412e+00   0.461   0.6449  
# Age.at.Solid.Introduction..months.4       2.341e+01  1.312e+05   0.000   0.9999  
# Age.at.Solid.Introduction..months.5       2.262e+01  1.312e+05   0.000   0.9999  
# Age.at.Solid.Introduction..months.6       2.327e+01  1.312e+05   0.000   0.9999  
# Age.at.Solid.Introduction..months.7       1.923e+01  1.312e+05   0.000   0.9999  
# Age.at.Solid.Introduction..months.8       4.394e+01  1.320e+05   0.000   0.9997  
# Dx.StatusCELIAC:month18                   8.747e-01  1.756e+00   0.498   0.6184  
# Dx.StatusCELIAC:month24                  -2.821e+01  5.116e+05   0.000   1.0000  
# Dx.StatusCELIAC:month30                  -1.569e+00  1.842e+00  -0.852   0.3942  
# Dx.StatusCELIAC:month36                  -1.244e+00  2.040e+00  -0.609   0.5422  
# Dx.StatusCELIAC:month48                   2.146e+01  2.787e+04   0.001   0.9994  
# Dx.StatusCELIAC:month54                   1.274e+01  9.613e+07   0.000   1.0000  
# Dx.StatusCELIAC:month60                   2.515e+00  2.012e+06   0.000   1.0000  
# Dx.StatusCELIAC:month72                   3.074e+00  3.382e+07   0.000   1.0000  
# Dx.StatusCELIAC:month84                  -8.626e+00  6.809e+07   0.000   1.0000 


glmer.entero.stats.df <- tidy(enterovirus.glm, conf.int = TRUE, exponentiate = TRUE) %>%
  filter(effect == "fixed")

glmer.entero.stats.df$stars <- cut(glmer.entero.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)

glmer.entero.stats.plot <- glmer.entero.stats.df %>%
  mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))

p.entero <- ggplot(glmer.entero.stats.plot, aes(y = term, x = estimate, 
                        xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
  geom_text(aes(label = sig), color = ifelse(glmer.entero.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
  geom_pointrange(position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
  scale_x_log10(limits = c(0.001, 10000), 
                breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
  labs(x = "Odds Ratio (log scale)", 
       y = "", 
       title = "Prediction of Enterovirus Presence in Case") +
  theme(legend.position = "none") +
  scale_color_identity()

ggsave(p.entero,file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/PA_plots_species/glmer.entero.pdf",width = 15, height = 15, dpi = 600)


```



# fishers' exact test - Anellovirus
```{r}


# Fit a logistic regression model
anellovirus.glm <- glmer(`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus` ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
    Age.at.Solid.Introduction..months. + (1 | patientID), 
    family = binomial(link = "logit"),
             data = glm.table.all)


summary(anellovirus.glm)
# Fixed effects:
#                                            Estimate Std. Error z value Pr(>|z|)  
# (Intercept)                              -2.136e+01  7.947e+04   0.000   0.9998  
# Dx.StatusCELIAC                          -3.347e-01  9.424e-01  -0.355   0.7225  
# month18                                  -1.604e+00  1.185e+00  -1.354   0.1757  
# month24                                  -1.257e+00  1.199e+00  -1.049   0.2944  
# month30                                  -1.162e+00  1.209e+00  -0.961   0.3366  
# month36                                  -2.043e+01  1.713e+04  -0.001   0.9990  
# month48                                  -2.048e+01  1.773e+04  -0.001   0.9991  
# month54                                  -4.954e+00  1.372e+06   0.000   1.0000  
# month60                                  -2.380e+01  1.229e+05   0.000   0.9998  
# month72                                  -4.923e+00  4.019e+05   0.000   1.0000  
# month84                                  -6.261e+00  7.844e+05   0.000   1.0000  
# CountryUSA                               -1.788e-01  1.066e+00  -0.168   0.8668  
# SexMale                                   5.237e-01  7.062e-01   0.742   0.4584  
# Delivery.ModeVaginal                     -4.108e-01  9.930e-01  -0.414   0.6791  
# HLA.CategoryLow/No Risk                  -2.061e+01  1.160e+04  -0.002   0.9986  
# HLA.CategoryStandard Risk                -1.119e+00  8.191e-01  -1.366   0.1721  
# feeding_first_yearBreastmilk_and_formula  3.253e-01  7.823e-01   0.416   0.6776  
# feeding_first_yearFormula                -6.095e-01  8.955e-01  -0.681   0.4961  
# Age.at.Gluten.Introduction..months.11    -8.997e-01  1.765e+00  -0.510   0.6102  
# Age.at.Gluten.Introduction..months.15    -2.247e+01  8.576e+04   0.000   0.9998  
# Age.at.Gluten.Introduction..months.36     1.909e+01  1.160e+04   0.002   0.9987  
# Age.at.Gluten.Introduction..months.4     -1.344e+00  2.262e+00  -0.594   0.5524  
# Age.at.Gluten.Introduction..months.5     -1.957e+00  1.774e+00  -1.103   0.2699  
# Age.at.Gluten.Introduction..months.6     -1.276e+00  1.457e+00  -0.876   0.3812  
# Age.at.Gluten.Introduction..months.7     -1.121e+00  1.191e+00  -0.941   0.3469  
# Age.at.Gluten.Introduction..months.8     -1.443e+00  1.502e+00  -0.961   0.3367  
# Age.at.Gluten.Introduction..months.9     -1.961e+00  1.541e+00  -1.272   0.2033  
# Age.at.Solid.Introduction..months.4       2.260e+01  7.947e+04   0.000   0.9998  
# Age.at.Solid.Introduction..months.5       2.188e+01  7.947e+04   0.000   0.9998  
# Age.at.Solid.Introduction..months.6       2.171e+01  7.947e+04   0.000   0.9998  
# Age.at.Solid.Introduction..months.7       2.105e+01  7.947e+04   0.000   0.9998  
# Age.at.Solid.Introduction..months.8      -4.120e+00  2.169e+05   0.000   1.0000  
# Dx.StatusCELIAC:month18                   2.533e+00  1.434e+00   1.766   0.0773 .
# Dx.StatusCELIAC:month24                   1.733e+00  1.520e+00   1.140   0.2541  
# Dx.StatusCELIAC:month30                   2.692e-01  1.725e+00   0.156   0.8760  
# Dx.StatusCELIAC:month36                   1.969e+01  1.713e+04   0.001   0.9991  
# Dx.StatusCELIAC:month48                   1.974e+01  1.773e+04   0.001   0.9991  
# Dx.StatusCELIAC:month54                  -1.780e+01  1.391e+06   0.000   1.0000  
# Dx.StatusCELIAC:month60                  -7.708e-01  2.193e+05   0.000   1.0000  
# Dx.StatusCELIAC:month72                  -1.852e+01  4.515e+05   0.000   1.0000  
# Dx.StatusCELIAC:month84                  -1.698e+01  8.062e+05   0.000   1.0000 


glmer.anello.stats.df <- tidy(anellovirus.glm, conf.int = TRUE, exponentiate = TRUE) %>%
  filter(effect == "fixed")

glmer.anello.stats.df$stars <- cut(glmer.anello.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)

glmer.anello.stats.plot <- glmer.anello.stats.df %>%
  mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))

p.anello <- ggplot(glmer.anello.stats.plot, aes(y = term, x = estimate, 
                        xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
  geom_text(aes(label = sig), color = ifelse(glmer.anello.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
  geom_pointrange(position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
  scale_x_log10(limits = c(0.001, 10000), 
                breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
  labs(x = "Odds Ratio (log scale)", 
       y = "", 
       title = "Prediction of Anellovirus Presence in Case") +
  theme(legend.position = "none") +
  scale_color_identity()

ggsave(p.anello,file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/PA_plots_species/glmer.anello.pdf",width = 15, height = 15, dpi = 600)



```



# fishers' exact test - Adeno−associated dependoparvovirus A
```{r}

# Fit a logistic regression model
dependoparvovirus.glm <- glmer(`Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A` ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
    Age.at.Solid.Introduction..months. + (1 | patientID), 
    family = binomial(link = "logit"),
             data = glm.table.all)


summary(dependoparvovirus.glm)
# Fixed effects:
#                                            Estimate Std. Error z value Pr(>|z|)
# (Intercept)                              -1.141e+00  3.722e+05   0.000    1.000
# Dx.StatusCELIAC                          -2.043e+01  3.930e+04  -0.001    1.000
# month18                                  -2.329e+01  5.004e+04   0.000    1.000
# month24                                  -1.351e+04  1.350e+07  -0.001    0.999
# month30                                  -7.163e+03  1.441e+07   0.000    1.000
# month36                                  -4.949e-01  1.511e+00  -0.327    0.743
# month48                                  -2.668e+03  1.693e+07   0.000    1.000
# month54                                  -2.299e+04  6.711e+07   0.000    1.000
# month60                                  -1.419e+04  2.392e+07  -0.001    1.000
# month72                                  -4.141e+03  4.899e+07   0.000    1.000
# month84                                  -7.204e+03  4.899e+07   0.000    1.000
# CountryUSA                                1.501e+01  2.691e+04   0.001    1.000
# SexMale                                  -2.130e+01  2.476e+04  -0.001    0.999
# Delivery.ModeVaginal                     -1.950e+01  2.691e+04  -0.001    0.999
# HLA.CategoryLow/No Risk                  -2.325e+03  1.216e+07   0.000    1.000
# HLA.CategoryStandard Risk                -6.087e-01  1.686e+00  -0.361    0.718
# feeding_first_yearBreastmilk_and_formula  1.225e+00  2.283e+00   0.537    0.592
# feeding_first_yearFormula                -2.603e+00  2.742e+00  -0.949    0.342
# Age.at.Gluten.Introduction..months.11    -1.207e+04  2.244e+07  -0.001    1.000
# Age.at.Gluten.Introduction..months.15     4.825e+01  4.454e+04   0.001    0.999
# Age.at.Gluten.Introduction..months.36    -1.886e+03  2.710e+07   0.000    1.000
# Age.at.Gluten.Introduction..months.4     -1.729e+04  3.336e+07  -0.001    1.000
# Age.at.Gluten.Introduction..months.5     -1.372e+04  2.327e+07  -0.001    1.000
# Age.at.Gluten.Introduction..months.6      1.820e+01  3.702e+04   0.000    1.000
# Age.at.Gluten.Introduction..months.7      1.991e+01  3.702e+04   0.001    1.000
# Age.at.Gluten.Introduction..months.8      2.342e+01  3.702e+04   0.001    0.999
# Age.at.Gluten.Introduction..months.9     -1.047e+04  1.316e+07  -0.001    0.999
# Age.at.Solid.Introduction..months.4      -2.397e+03  1.386e+07   0.000    1.000
# Age.at.Solid.Introduction..months.5      -1.650e+01  3.740e+05   0.000    1.000
# Age.at.Solid.Introduction..months.6      -2.047e+01  3.740e+05   0.000    1.000
# Age.at.Solid.Introduction..months.7      -2.146e+01  3.740e+05   0.000    1.000
# Age.at.Solid.Introduction..months.8      -4.314e+03  3.067e+07   0.000    1.000
# Dx.StatusCELIAC:month18                   4.496e+01  6.363e+04   0.001    0.999
# Dx.StatusCELIAC:month24                   2.497e+03  2.082e+07   0.000    1.000
# Dx.StatusCELIAC:month30                  -1.315e+04  2.126e+07  -0.001    1.000
# Dx.StatusCELIAC:month36                  -1.028e+04  1.720e+07  -0.001    1.000
# Dx.StatusCELIAC:month48                  -5.630e+03  2.430e+07   0.000    1.000
# Dx.StatusCELIAC:month54                   2.914e+04  9.762e+07   0.000    1.000
# Dx.StatusCELIAC:month60                   9.054e+03  3.422e+07   0.000    1.000
# Dx.StatusCELIAC:month72                  -2.305e+04  6.925e+07   0.000    1.000
# Dx.StatusCELIAC:month84                   5.122e+03  6.925e+07   0.000    1.000


glmer.dependoparvovirus.stats.df <- tidy(dependoparvovirus.glm, conf.int = TRUE, exponentiate = TRUE) %>%
  filter(effect == "fixed")

glmer.dependoparvovirus.stats.df$stars <- cut(glmer.dependoparvovirus.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)

glmer.dependoparvovirus.stats.plot <- glmer.dependoparvovirus.stats.df %>%
  mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))

p.dependoparvovirus <- ggplot(glmer.dependoparvovirus.stats.plot, aes(y = term, x = estimate, 
                        xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
  geom_text(aes(label = sig), color = ifelse(glmer.dependoparvovirus.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
  geom_pointrange(position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
  scale_x_log10(limits = c(0.001, 10000), 
                breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
  labs(x = "Odds Ratio (log scale)", 
       y = "", 
       title = "Prediction of  Adeno−associated dependoparvovirus A Presence in Case") +
  theme(legend.position = "none") +
  scale_color_identity()

ggsave(p.dependoparvovirus,file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/PA_plots_species/glmer.dependoparvovirus.pdf",width = 15, height = 15, dpi = 600)




```


# fisher's exact test - Adenovirus Lopburi070/2006/THA
```{r}

rownames(count.species)[rownames(count.species) %like% "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA"]


# Fit a logistic regression model
Adenoviridae.glm <- glmer(`Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA` ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
    HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
    Age.at.Solid.Introduction..months. + (1 | patientID), 
    family = binomial(link = "logit"),
             data = glm.table.all)

# Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev,  : 
#   Downdated VtV is not positive definite
summary(dependoparvovirus.glm)

```



###########################
# GLMER - picornaviridae #
##########################


################
#    Genus     #
################

```{r}


count.genus.glm <- count.genus
count.genus.glm[count.genus.glm != 0] <- 1

# merge count table and metadata table
glm.table.genus.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



glm.table.genus.all$month <- factor(glm.table.genus.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
glm.table.genus.all$Dx.Status <- factor(glm.table.genus.all$Dx.Status,levels = c("CONTROL","CELIAC"))


#extract genus of Picornaviridae
Picornaviridae.genus <- rownames(count.genus)[rownames(count.genus) %like% "Picornaviridae"]
Picornaviridae.genus.shortname <- gsub("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;","",Picornaviridae.genus)



for (i in Picornaviridae.genus.shortname){
  
    print(i)
  
    genus1 <- colnames(glm.table.genus.all)[colnames(glm.table.genus.all) %like% i]
    
    
    print(paste0("test:",i))
    
    
    
    Picornaviridae.glm <- glmer(get(genus1) ~ Dx.Status * month + Country + Sex + Delivery.Mode + 
                          HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                          Age.at.Solid.Introduction..months. + (1 | patientID), 
                          family = binomial(link = "logit"),
                          data = glm.table.genus.all)
                        
    
     fit.glance <- glance(Picornaviridae.glm)

     fit.tidy <- tidy(Picornaviridae.glm) %>%
                 add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

     write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/fisher/genus/",i,"_fisher.csv"))
     
     
     
     glmer.stats.df <- tidy(Picornaviridae.glm, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
      glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
      glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
      p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = "Prediction") +
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/fisher/genus/",i,"_fisher_pdf.pdf"),width = 15, height = 15, dpi = 600)
      

  
}



```



################
#    Species   #
################

```{r}

count.species.glm <- count.species
count.species.glm[count.species.glm != 0] <- 1

# merge count table and metadata table
glm.table.species.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



glm.table.species.all$month <- factor(glm.table.species.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
glm.table.species.all$Dx.Status <- factor(glm.table.species.all$Dx.Status,levels = c("CONTROL","CELIAC"))


#extract genus of Picornaviridae
Picornaviridae.species <- rownames(count.species)[rownames(count.species) %like% "Picornaviridae"]
Picornaviridae.species.shortname <- gsub("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;","",Picornaviridae.species)


# `Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus C
#  Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species
#  Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus E
#  Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus sp.
# Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species
#  Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev,  : 
#  Downdated VtV is not positive definite

problemetic.species <- c("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus C",
                                    "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;unclassified Cardiovirus species",
                                    "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus E",
                                    "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Enterovirus sp.",
                                    "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus 113",
                         "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human rhinovirus sp.",
                         "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Rhinovirus B",
                         "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Rhinovirus C",
                         "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Kobuvirus;unclassified Kobuvirus species",
                         "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;unclassified Picornaviridae genus;Leveillula taurica associated picorna-like virus 1")

Picornaviridae.species <- Picornaviridae.species[!Picornaviridae.species %in% problemetic.species]

for (i in Picornaviridae.species){
  
    print(i)
  
    species1 <- colnames(glm.table.species.all)[colnames(glm.table.species.all) %like% i]
    
    
    print(paste0("test:",i))
    
    if(length(unique(glm.table.species.all %>% pull(get(i)))) == 1){
      
        next
        
    }else{
      

    
    Picornaviridae.glm <- glmer(get(i) ~ Dx.Status : month + Country + Sex + Delivery.Mode + 
                          HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + 
                          Age.at.Solid.Introduction..months. + (1 | patientID), 
                          family = binomial(link = "logit"),
                          data = glm.table.species.all)
                        
    
     fit.glance <- glance(Picornaviridae.glm)

     fit.tidy <- tidy(Picornaviridae.glm) %>%
                 add_column(r.square = fit.glance$r.squared,
                            adj.r.square = fit.glance$adj.r.squared)

     write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/fisher/species/",i,"_fisher.csv"))
     
     
     
     
     glmer.stats.df <- tidy(Picornaviridae.glm, conf.int = TRUE, exponentiate = TRUE) %>%
                       filter(effect == "fixed")
      
      glmer.stats.df$stars <- cut(glmer.stats.df$p.value, breaks = c(-Inf, 0.0001, 0.001, 0.01, 0.05, Inf), labels = c("****","***", "**", "*", "n.s."), right = FALSE)
      
      glmer.stats.plot <- glmer.stats.df %>%
        mutate(sig = paste(sprintf(estimate, fmt = '%.2f'),stars,sep=" "))
      
      p <- ggplot(glmer.stats.plot, aes(y = term, x = estimate, 
                              xmin = conf.low, xmax = conf.high, color = ifelse(p.value>0.05, 'black', 'red'))) +
        geom_text(aes(label = sig), color = ifelse(glmer.stats.plot$p.value>0.05, 'black', 'red'), vjust = -0.5, hjust = 0.51, size = 4, position = position_dodge(width = 0.5), show.legend = F) +
        geom_pointrange(position = position_dodge(width = 0.5)) +
        geom_vline(xintercept = 1, linetype = "dashed", color = "gray") +
        scale_x_log10(limits = c(0.001, 10000), 
                      breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
                      labels = c("1e-03","1e-02", "1e-01", "1e+00", "1e+01", "1e+02", "1e+03")) +
        labs(x = "Odds Ratio (log scale)", 
             y = "", 
             title = "Prediction") +
        theme(legend.position = "none") +
        scale_color_identity()
      
      ggsave(p,file=paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/fisher/species/",i,"_fisher_pdf.pdf"),width = 15, height = 15, dpi = 600)
      
     
     
     
    }
  
}



```



#########################################
# Cox PH moel for survival analysis     #
#                                       #
#########################################


# Species level Cox PH models
```{r}


rownames(count.species) <- gsub("/","_",rownames(count.species))

species.name <- colnames(glm.table.all)[26:317]
new.species.name <- gsub("/|-","_",species.name)
colnames(glm.table.all)[26:317] <- new.species.name


glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))



stats.list <- list()

for (i in new.species.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/species/",i,"_cox.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == "get(i)") %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


species.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))


p.species.stats <- ggplot(species.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(species.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
 ggsave(p.species.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/species/species.cox.res.pdf",width = 25, height = 45,dpi=600)


```


# Genus level Cox PH models
```{r}


rownames(count.genus) <- gsub("/","_",rownames(count.genus))

genus.name <- colnames(glm.table.genus.all)[26:77]
new.genus.name <- gsub("/|-","_",genus.name)
colnames(glm.table.genus.all)[26:77] <- new.genus.name


glm.table.genus.all$Dx.Status <- as.numeric(ifelse(glm.table.genus.all$Dx.Status == "CONTROL",0,1))



stats.list <- list()

for (i in new.genus.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.genus.all)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus/",i,"_cox.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == "get(i)") %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


genus.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))


p.genus.stats <- ggplot(genus.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(genus.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
 ggsave(p.genus.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/genus/genus.cox.res.pdf",width = 25, height = 30,dpi=600)



```


# Family level Cox PH models
```{r}


rownames(count.family) <- gsub("/","_",rownames(count.family))

family.name <- colnames(glm.table.family.all)[26:38]
new.family.name <- gsub("/|-","_",family.name)
colnames(glm.table.family.all)[26:38] <- new.family.name


glm.table.family.all$Dx.Status <- as.numeric(ifelse(glm.table.family.all$Dx.Status == "CONTROL",0,1))



stats.list <- list()

for (i in new.family.name) {
  result <- tryCatch({
    
    print(paste("Processing i =", i))
    # Example code that may cause the specific error
    cox.fit <- coxph(Surv(month, Dx.Status) ~ get(i) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.family.all)


    fit.tidy <- tidy(cox.fit)

    write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/",i,"_cox.csv"))
     
     print("test1")
     
     
     df <- data.frame(summary(cox.fit)$coefficients) %>%
           filter(row.names(.) == "get(i)") %>%
           rownames_to_column("taxa") %>% 
           mutate(taxa = i)
     
     print(dim(df))
     
     stats.list[[i]] <- df

      print("test2")
       
       NULL  # Return a value if no error occurs
  }, error = function(e) {
    # Check if the error message matches the specific condition
    if (grepl("Downdated VtV is not positive definite", e$message)||grepl("Response is constant", e$message)) {
      message(paste("Caught specific error at iteration", i, "- skipping to next iteration"))
      return(NULL)  # Return NULL to indicate the error occurred and skip the current iteration
    }
    stop(e)  # Rethrow the error if it doesn't match the condition
  })
  
  # If result is NULL, skip to the next iteration
  if (is.null(result)) {
    next  # Skip to the next iteration if the specific error occurred
  }
}


family.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))


p.family.stats <- ggplot(family.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(family.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
 ggsave(p.family.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/COX/family/family.cox.res.pdf",width = 15, height = 8,dpi=600)






```



coxph model - picornaviridae - genus
```{r}

glm.table.genus.all$month <- as.numeric(glm.table.all$month)
glm.table.genus.all$Dx.Status <- as.numeric(ifelse(glm.table.genus.all$Dx.Status == "CONTROL",0,1))



#extract genus of Picornaviridae
Picornaviridae.genus <- rownames(count.genus)[rownames(count.genus) %like% "Picornaviridae"]
Picornaviridae.genus.shortname <- gsub("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;","",Picornaviridae.genus)




stats.list <- list()

for (i in 1 : length(Picornaviridae.genus)){
  
    print(Picornaviridae.genus[i])

    
    print(paste0("test:",Picornaviridae.genus[i]))

    Picorna.res.cox <- coxph(Surv(month, Dx.Status) ~ get(Picornaviridae.genus[i]) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.genus.all)
                        

     fit.tidy <- tidy(Picorna.res.cox)

     write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/genus/",Picornaviridae.genus[i],"_coxph.csv"))
     
     
      stats.list[[i]] <- data.frame(summary(Picorna.res.cox)$coefficients) %>% 
                    filter(row.names(.) == "get(Picornaviridae.genus[i])") %>% 
                    rownames_to_column("taxa") %>% mutate(taxa = Picornaviridae.genus[i])


}


Picorna.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))

write.csv(Picorna.cox.res,"~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/genus/Picorna.cox.res.csv")


p.genus.stats <- ggplot(Picorna.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(Picorna.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
 ggsave(p.genus.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/genus/Picorna.cox.res.pdf",width = 15, height = 5,dpi=600)





```


coxph model - picornaviridae - species
```{r}

glm.table.species.all$month <- as.numeric(glm.table.species.all$month)
glm.table.species.all$Dx.Status <- as.numeric(ifelse(glm.table.species.all$Dx.Status == "CONTROL",0,1))


glm.table.species.all$`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;Cardiovirus B`
glm.table.species.all$`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;Cardiovirus C`
glm.table.species.all$`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;Goat cardiovirus`
glm.table.species.all$`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Cardiovirus;Rodent Cardiovirus`

#extract genus of Picornaviridae
Picornaviridae.species <- rownames(count.species)[rownames(count.species) %like% "Picornaviridae"]
Picornaviridae.species.shortname <- gsub("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;","",Picornaviridae.species)



stats.list <- list()

for (i in 1 : length(Picornaviridae.species)){
  
    print(i)

    
    print(paste0("test:",i))
    
    
    
    Picorna.res.cox <- coxph(Surv(month, Dx.Status) ~ get(Picornaviridae.species[i]) + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.species.all)
                        

     fit.tidy <- tidy(Picorna.res.cox)

     write.csv(fit.tidy,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/species/",Picornaviridae.species[i],"_coxph.csv"))
     
     
     
        stats.list[[i]] <- data.frame(summary(Picorna.res.cox)$coefficients) %>% 
                    filter(row.names(.) == "get(Picornaviridae.species[i])") %>% 
                    rownames_to_column("taxa") %>% mutate(taxa = Picornaviridae.species[i])

  
}


Picorna.cox.res <- bind_rows(stats.list) %>%
                   mutate(`P-Value` = ifelse(`Pr...z..` < 0.05,"Significant","non-Significant"))

write.csv(Picorna.cox.res,"~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/species/Picorna.cox.res.csv")


p.species.stats <- ggplot(Picorna.cox.res,aes(x = `exp.coef.`,y=taxa,color = `P-Value`)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0,linetype="dotted") +
  scale_color_manual(values = c("Significant" = "red", "non-Significant" = "black")) +
  geom_text_repel(data = subset(Picorna.cox.res, `P-Value` == "Significant"), aes(label = `Pr...z..`)) +
  theme(axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 10,face = "bold"))

 
 ggsave(p.species.stats,file="~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/coxph/species/Picorna.cox.res.pdf",width = 22, height = 10,dpi=600)


```


coxph model  - Astrovirus
```{r}

library("survival")
library("survminer")


glm.table.all$month <- as.numeric(glm.table.all$month)
glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))

astro.res.cox <- coxph(Surv(month, Dx.Status) ~ `Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)


summary(astro.res.cox)
#                                                                                                                         coef    exp(coef)     se(coef)    z   Pr(>|z|) 
# `Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` -7.686e-02  9.260e-01  7.499e-01 -0.102   0.9184
# CountryUSA                                                                                                            3.991e-01  1.490e+00  5.622e-01  0.710   0.4778
# SexMale                                                                                                               7.210e-01  2.057e+00  3.235e-01  2.229   0.0258
# Delivery.ModeVaginal                                                                                                 -1.210e+00  2.983e-01  5.813e-01 -2.081   0.0374
# HLA.CategoryLow/No Risk                                                                                              -3.752e-01  6.872e-01  4.231e-01 -0.887   0.3753
# HLA.CategoryStandard Risk                                                                                            -5.139e-01  5.982e-01  2.939e-01 -1.749   0.0804
# feeding_first_yearBreastmilk_and_formula                                                                             -1.782e-01  8.368e-01  3.261e-01 -0.546   0.5848
# feeding_first_yearFormula                                                                                            -8.509e-02  9.184e-01  3.416e-01 -0.249   0.8033
# Age.at.Gluten.Introduction..months.11                                                                                 1.967e+01  3.477e+08  2.327e+03  0.008   0.9933
# Age.at.Gluten.Introduction..months.15                                                                                -4.104e-01  6.634e-01  3.727e+03  0.000   0.9999
# Age.at.Gluten.Introduction..months.36                                                                                 1.953e+01  3.043e+08  2.327e+03  0.008   0.9933
# Age.at.Gluten.Introduction..months.4                                                                                  1.974e+01  3.738e+08  2.327e+03  0.008   0.9932
# Age.at.Gluten.Introduction..months.5                                                                                  1.999e+01  4.786e+08  2.327e+03  0.009   0.9931
# Age.at.Gluten.Introduction..months.6                                                                                  1.931e+01  2.442e+08  2.327e+03  0.008   0.9934
# Age.at.Gluten.Introduction..months.7                                                                                  1.845e+01  1.033e+08  2.327e+03  0.008   0.9937
# Age.at.Gluten.Introduction..months.8                                                                                  1.864e+01  1.251e+08  2.327e+03  0.008   0.9936
# Age.at.Gluten.Introduction..months.9                                                                                  2.016e+01  5.665e+08  2.327e+03  0.009   0.9931
# Age.at.Solid.Introduction..months.4                                                                                   3.832e-01  1.467e+00  3.376e+04  0.000   1.0000
# Age.at.Solid.Introduction..months.5                                                                                   4.136e-01  1.512e+00  3.376e+04  0.000   1.0000
# Age.at.Solid.Introduction..months.6                                                                                   6.268e-01  1.872e+00  3.376e+04  0.000   1.0000
# Age.at.Solid.Introduction..months.7                                                                                   1.178e-01  1.125e+00  3.376e+04  0.000   1.0000
# Age.at.Solid.Introduction..months.8                                                                                   2.101e+01  1.326e+09  3.368e+04  0.001   0.9995




#                                                                                                                     exp(coef) exp(-coef) lower .95 upper .95
# `Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` 9.260e-01  1.080e+00   0.21296     4.027
# CountryUSA                                                                                                           1.490e+00  6.709e-01   0.49518     4.486
# SexMale                                                                                                              2.057e+00  4.863e-01   1.09092     3.877
# Delivery.ModeVaginal                                                                                                 2.983e-01  3.352e+00   0.09547     0.932
# HLA.CategoryLow/No Risk                                                                                              6.872e-01  1.455e+00   0.29983     1.575
# HLA.CategoryStandard Risk                                                                                            5.982e-01  1.672e+00   0.33626     1.064
# feeding_first_yearBreastmilk_and_formula                                                                             8.368e-01  1.195e+00   0.44163     1.586
# feeding_first_yearFormula                                                                                            9.184e-01  1.089e+00   0.47018     1.794
# Age.at.Gluten.Introduction..months.11                                                                                3.477e+08  2.876e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.15                                                                                6.634e-01  1.507e+00   0.00000       Inf
# Age.at.Gluten.Introduction..months.36                                                                                3.043e+08  3.287e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.4                                                                                 3.738e+08  2.675e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.5                                                                                 4.786e+08  2.090e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.6                                                                                 2.442e+08  4.094e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.7                                                                                 1.033e+08  9.682e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.8                                                                                 1.251e+08  7.992e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.9                                                                                 5.665e+08  1.765e-09   0.00000       Inf
# Age.at.Solid.Introduction..months.4                                                                                  1.467e+00  6.817e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.5                                                                                  1.512e+00  6.613e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.6                                                                                  1.872e+00  5.343e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.7                                                                                  1.125e+00  8.889e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.8                                                                                  1.326e+09  7.540e-10   0.00000       Inf





```

coxph model  - Enterovirus
```{r}


glm.table.all$month <- as.numeric(glm.table.all$month)
glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))

Entero.res.cox <- coxph(Surv(month, Dx.Status) ~ `Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)


summary(Entero.res.cox)
#                                                                                                          coef  exp(coef)   se(coef)      z Pr(>|z|)  
# `Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus` -5.921e-01  5.532e-01  3.842e-01 -1.541   0.1233  
# CountryUSA                                                                                          4.162e-01  1.516e+00  5.620e-01  0.740   0.4590  
# SexMale                                                                                             7.974e-01  2.220e+00  3.278e-01  2.433   0.0150 *
# Delivery.ModeVaginal                                                                               -1.360e+00  2.566e-01  5.901e-01 -2.306   0.0211 *
# HLA.CategoryLow/No Risk                                                                            -4.906e-01  6.123e-01  4.308e-01 -1.139   0.2548  
# HLA.CategoryStandard Risk                                                                          -5.523e-01  5.756e-01  2.950e-01 -1.872   0.0612 .
# feeding_first_yearBreastmilk_and_formula                                                           -1.743e-01  8.400e-01  3.255e-01 -0.536   0.5923  
# feeding_first_yearFormula                                                                          -1.151e-01  8.913e-01  3.432e-01 -0.335   0.7374  
# Age.at.Gluten.Introduction..months.11                                                               1.963e+01  3.349e+08  2.311e+03  0.008   0.9932  
# Age.at.Gluten.Introduction..months.15                                                              -4.621e-01  6.300e-01  3.715e+03  0.000   0.9999  
# Age.at.Gluten.Introduction..months.36                                                               1.962e+01  3.309e+08  2.311e+03  0.008   0.9932  
# Age.at.Gluten.Introduction..months.4                                                                1.961e+01  3.286e+08  2.311e+03  0.008   0.9932  
# Age.at.Gluten.Introduction..months.5                                                                1.992e+01  4.490e+08  2.311e+03  0.009   0.9931  
# Age.at.Gluten.Introduction..months.6                                                                1.935e+01  2.528e+08  2.311e+03  0.008   0.9933  
# Age.at.Gluten.Introduction..months.7                                                                1.840e+01  9.772e+07  2.311e+03  0.008   0.9936  
# Age.at.Gluten.Introduction..months.8                                                                1.864e+01  1.240e+08  2.311e+03  0.008   0.9936  
# Age.at.Gluten.Introduction..months.9                                                                2.024e+01  6.181e+08  2.311e+03  0.009   0.9930  
# Age.at.Solid.Introduction..months.4                                                                 5.449e-01  1.724e+00  3.396e+04  0.000   1.0000  
# Age.at.Solid.Introduction..months.5                                                                 5.845e-01  1.794e+00  3.396e+04  0.000   1.0000  
# Age.at.Solid.Introduction..months.6                                                                 7.824e-01  2.187e+00  3.396e+04  0.000   1.0000  
# Age.at.Solid.Introduction..months.7                                                                 2.556e-01  1.291e+00  3.396e+04  0.000   1.0000  
# Age.at.Solid.Introduction..months.8                                                                 2.136e+01  1.900e+09  3.389e+04  0.001   0.9995  


#                                                                                                    exp(coef) exp(-coef) lower .95 upper .95
# `Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus` 5.532e-01  1.808e+00   0.26055    1.1745
# CountryUSA                                                                                         1.516e+00  6.596e-01   0.50388    4.5620
# SexMale                                                                                            2.220e+00  4.505e-01   1.16754    4.2200
# Delivery.ModeVaginal                                                                               2.566e-01  3.898e+00   0.08071    0.8155
# HLA.CategoryLow/No Risk                                                                            6.123e-01  1.633e+00   0.26317    1.4244
# HLA.CategoryStandard Risk                                                                          5.756e-01  1.737e+00   0.32285    1.0263
# feeding_first_yearBreastmilk_and_formula                                                           8.400e-01  1.190e+00   0.44386    1.5898
# feeding_first_yearFormula                                                                          8.913e-01  1.122e+00   0.45488    1.7464
# Age.at.Gluten.Introduction..months.11                                                              3.349e+08  2.986e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.15                                                              6.300e-01  1.587e+00   0.00000       Inf
# Age.at.Gluten.Introduction..months.36                                                              3.309e+08  3.022e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.4                                                               3.286e+08  3.043e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.5                                                               4.490e+08  2.227e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.6                                                               2.528e+08  3.955e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.7                                                               9.772e+07  1.023e-08   0.00000       Inf
# Age.at.Gluten.Introduction..months.8                                                               1.240e+08  8.065e-09   0.00000       Inf
# Age.at.Gluten.Introduction..months.9                                                               6.181e+08  1.618e-09   0.00000       Inf
# Age.at.Solid.Introduction..months.4                                                                1.724e+00  5.799e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.5                                                                1.794e+00  5.574e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.6                                                                2.187e+00  4.573e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.7                                                                1.291e+00  7.744e-01   0.00000       Inf
# Age.at.Solid.Introduction..months.8                                                                1.900e+09  5.265e-10   0.00000       Inf
# 
# Concordance= 0.757  (se = 0.023 )
# Likelihood ratio test= 133.5  on 22 df,   p=<2e-16
# Wald test            = 55.58  on 22 df,   p=1e-04
# Score (logrank) test = 115.5  on 22 df,   p=1e-14


```


coxph model - Anellovirus

Interpretation:
The hazard ratio for being USA patients is 0.46117, meaning USA patients have a 1/0.46117=2.168 lower risk of develop Celiac disease, compared to Italy, at every time point during the study. This result is statistically significant with a p-value of 0.00273.
```{r}


View(glm.table.all %>% filter(`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus` == 1) %>% select(patientID,month,Dx.Status,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`) %>% arrange(patientID))


heatmap.df <- glm.table.all %>% 
             select(month,Dx.Status,`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`) %>%
             rename(`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus` = "Anelloviridae_PA") %>%
             group_by(month,Dx.Status) %>%
             mutate(count = sum(Anelloviridae_PA))



# Step 3: Create the heatmap
ggplot(heatmap.df, aes(x = Dx.Status, y = month, fill = count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = count), color = "red", size = 3) + 
  labs(title = "Presence and Absence of Anelloviridae",
       x = "Groups", y = "Timepoints", fill = "Presence") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))




View(heatmap.df %>% filter(Anelloviridae_PA == 1))






glm.table.all$month <- as.numeric(glm.table.all$month)
glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))

Anello.res.cox <- coxph(Surv(month, Dx.Status) ~ `Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)

summary(Anello.res.cox)

#                                                                           coef  exp(coef)     se(coef)    z  Pr(>|z|)
# `Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`   0.72985   2.07477      0.24357  2.996  0.00273
# CountryUSA                                                             -0.77398   0.46117     0.23979 -3.228  0.00125
# SexMale                                                                0.27711   1.31932      0.18289  1.515  0.12972
# Delivery.ModeVaginal                                                   0.37853   1.46014      0.22657  1.671  0.09479
# HLA.CategoryLow/No Risk                                                0.04053   1.04136      0.25764  0.157  0.87501
# HLA.CategoryStandard Risk                                              0.07711   1.08017      0.18670  0.413  0.67957
# feeding_first_yearBreastmilk_and_formula                               0.08901   1.09309      0.16156  0.551  0.58169
# feeding_first_yearFormula                                              0.16878   1.18385      0.20271  0.833  0.40506
# Age.at.Gluten.Introduction..months.11                                  0.29622   1.34476      0.42807  0.692  0.48895
# Age.at.Gluten.Introduction..months.15                                  0.01574   1.01586      0.38471  0.041  0.96737
# Age.at.Gluten.Introduction..months.36                                  -0.36741   0.69252     0.46457 -0.791  0.42902
# Age.at.Gluten.Introduction..months.4                                   0.01557   1.01569      0.59110  0.026  0.97899
# Age.at.Gluten.Introduction..months.5                                   0.56094   1.75232      0.46177  1.215  0.22446
# Age.at.Gluten.Introduction..months.6                                   0.34959   1.41849      0.28934  1.208  0.22696
# Age.at.Gluten.Introduction..months.7                                   0.32002   1.37716      0.24300  1.317  0.18786
# Age.at.Gluten.Introduction..months.8                                   0.33816   1.40236      0.29230  1.157  0.24732
# Age.at.Gluten.Introduction..months.9                                   0.44465   1.55995      0.28907  1.538  0.12399
# Age.at.Solid.Introduction..months.4                                    -2.38375   0.09220     1.08711 -2.193  0.02833
# Age.at.Solid.Introduction..months.5                                    -2.10829   0.12145     1.05225 -2.004  0.04511
# Age.at.Solid.Introduction..months.6                                    -2.04764   0.12904     1.06201 -1.928  0.05384
# Age.at.Solid.Introduction..months.7                                    -1.88352   0.15205     1.05508 -1.785  0.07423
# Age.at.Solid.Introduction..months.8                                    -1.82075   0.16190     1.19941 -1.518  0.12900
# 


#                                                                                                                                                               exp(coef) exp(-coef)
# `Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`    2.0748     0.4820
# CountryUSA                                                                                                                                                        0.4612     2.1684
# SexMale                                                                                                                                                           1.3193     0.7580
# Delivery.ModeVaginal                                                                                                                                              1.4601     0.6849
# HLA.CategoryLow/No Risk                                                                                                                                           1.0414     0.9603
# HLA.CategoryStandard Risk                                                                                                                                         1.0802     0.9258
# feeding_first_yearBreastmilk_and_formula                                                                                                                          1.0931     0.9148
# feeding_first_yearFormula                                                                                                                                         1.1839     0.8447
# Age.at.Gluten.Introduction..months.11                                                                                                                             1.3448     0.7436
# Age.at.Gluten.Introduction..months.15                                                                                                                             1.0159     0.9844
# Age.at.Gluten.Introduction..months.36                                                                                                                             0.6925     1.4440
# Age.at.Gluten.Introduction..months.4                                                                                                                              1.0157     0.9846
# Age.at.Gluten.Introduction..months.5                                                                                                                              1.7523     0.5707
# Age.at.Gluten.Introduction..months.6                                                                                                                              1.4185     0.7050
# Age.at.Gluten.Introduction..months.7                                                                                                                              1.3772     0.7261
# Age.at.Gluten.Introduction..months.8                                                                                                                              1.4024     0.7131
# Age.at.Gluten.Introduction..months.9                                                                                                                              1.5600     0.6410
# Age.at.Solid.Introduction..months.4                                                                                                                               0.0922    10.8455
# Age.at.Solid.Introduction..months.5                                                                                                                               0.1214     8.2342
# Age.at.Solid.Introduction..months.6                                                                                                                               0.1290     7.7496
# Age.at.Solid.Introduction..months.7                                                                                                                               0.1521     6.5766
# Age.at.Solid.Introduction..months.8                                                                                                                               0.1619     6.1765
# 
#                                                                                                                                                                lower .95 upper .95
# `Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`   1.28719    3.3442
# CountryUSA                                                                                                                                                       0.28824    0.7379
# SexMale                                                                                                                                                          0.92188    1.8881
# Delivery.ModeVaginal                                                                                                                                             0.93656    2.2764
# HLA.CategoryLow/No Risk                                                                                                                                          0.62848    1.7255
# HLA.CategoryStandard Risk                                                                                                                                        0.74916    1.5574
# feeding_first_yearBreastmilk_and_formula                                                                                                                         0.79641    1.5003
# feeding_first_yearFormula                                                                                                                                        0.79571    1.7613
# Age.at.Gluten.Introduction..months.11                                                                                                                            0.58112    3.1119
# Age.at.Gluten.Introduction..months.15                                                                                                                            0.47794    2.1592
# Age.at.Gluten.Introduction..months.36                                                                                                                            0.27861    1.7214
# Age.at.Gluten.Introduction..months.4                                                                                                                             0.31887    3.2353
# Age.at.Gluten.Introduction..months.5                                                                                                                             0.70885    4.3318
# Age.at.Gluten.Introduction..months.6                                                                                                                             0.80452    2.5010
# Age.at.Gluten.Introduction..months.7                                                                                                                             0.85534    2.2173
# Age.at.Gluten.Introduction..months.8                                                                                                                             0.79078    2.4869
# Age.at.Gluten.Introduction..months.9                                                                                                                             0.88523    2.7489
# Age.at.Solid.Introduction..months.4                                                                                                                              0.01095    0.7764
# Age.at.Solid.Introduction..months.5                                                                                                                              0.01544    0.9551
# Age.at.Solid.Introduction..months.6                                                                                                                              0.01610    1.0344
# Age.at.Solid.Introduction..months.7                                                                                                                              0.01923    1.2025
# Age.at.Solid.Introduction..months.8                                                                                                                              0.01543    1.6990


```



coxph model - Adeno−associated dependoparvovirus A

Interpretation:
The hazard ratio for the presence of Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A` is 2.886615, meaning patients have this virus patients have 2.88 higher risk of develop Celiac disease, compared to patients who do not have this virus, at every time point during the study. This result is statistically significant with a p-value of 0.03041.
```{r}

glm.table.all$month <- as.numeric(glm.table.all$month)
glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))
glm.table.all$`Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A` <- factor(glm.table.all$`Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A`,levels = c(0,1))



Adeno.res.cox <- coxph(Surv(month, Dx.Status) ~ `Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)


summary(Adeno.res.cox)

#                                                                                                                               coef exp(coef)  se(coef)      z Pr(>|z|) 
# `Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A`  1.060085  2.886615  0.489719  2.165  0.03041 * 
# CountryUSA                                                                                                               -0.755248  0.469894  0.240174 -3.145  0.00166 **
# SexMale                                                                                                                   0.293989  1.341769  0.186223  1.579  0.11441   
# Delivery.ModeVaginal                                                                                                      0.315967  1.371586  0.226495  1.395  0.16301   
# HLA.CategoryLow/No Risk                                                                                                   0.008703  1.008741  0.255973  0.034  0.97288   
# HLA.CategoryStandard Risk                                                                                                 0.041256  1.042119  0.185403  0.223  0.82391   
# feeding_first_yearBreastmilk_and_formula                                                                                  0.125607  1.133836  0.162878  0.771  0.44061   
# feeding_first_yearFormula                                                                                                 0.164755  1.179104  0.202565  0.813  0.41602   
# Age.at.Gluten.Introduction..months.11                                                                                     0.312399  1.366699  0.430105  0.726  0.46764   
# Age.at.Gluten.Introduction..months.15                                                                                    -0.165543  0.847433  0.400919 -0.413  0.67967   
# Age.at.Gluten.Introduction..months.36                                                                                    -0.338698  0.712698  0.464942 -0.728  0.46632   
# Age.at.Gluten.Introduction..months.4                                                                                      0.249295  1.283121  0.584115  0.427  0.66953   
# Age.at.Gluten.Introduction..months.5                                                                                      0.470975  1.601555  0.464379  1.014  0.31049   
# Age.at.Gluten.Introduction..months.6                                                                                      0.355279  1.426579  0.287266  1.237  0.21618   
# Age.at.Gluten.Introduction..months.7                                                                                      0.338344  1.402623  0.243214  1.391  0.16418   
# Age.at.Gluten.Introduction..months.8                                                                                      0.363746  1.438709  0.291882  1.246  0.21269   
# Age.at.Gluten.Introduction..months.9                                                                                      0.423217  1.526866  0.290399  1.457  0.14502   
# Age.at.Solid.Introduction..months.4                                                                                      -2.240811  0.106372  1.085875 -2.064  0.03906 * 
# Age.at.Solid.Introduction..months.5                                                                                      -2.081230  0.124777  1.052596 -1.977  0.04802 * 
# Age.at.Solid.Introduction..months.6                                                                                      -1.974755  0.138795  1.062821 -1.858  0.06316 . 
# Age.at.Solid.Introduction..months.7                                                                                      -1.847715  0.157597  1.055185 -1.751  0.07993 . 
# Age.at.Solid.Introduction..months.8                                                                                      -1.770884  0.170182  1.202169 -1.473  0.14073   


#                                                                                                                         exp(coef) exp(-coef) lower .95 upper .95
# `Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A`    2.8866     0.3464   1.10545    7.5377
# CountryUSA                                                                                                                  0.4699     2.1281   0.29347    0.7524
# SexMale                                                                                                                     1.3418     0.7453   0.93146    1.9328
# Delivery.ModeVaginal                                                                                                        1.3716     0.7291   0.87989    2.1380
# HLA.CategoryLow/No Risk                                                                                                     1.0087     0.9913   0.61079    1.6660
# HLA.CategoryStandard Risk                                                                                                   1.0421     0.9596   0.72461    1.4988
# feeding_first_yearBreastmilk_and_formula                                                                                    1.1338     0.8820   0.82396    1.5602
# feeding_first_yearFormula                                                                                                   1.1791     0.8481   0.79274    1.7538
# Age.at.Gluten.Introduction..months.11                                                                                       1.3667     0.7317   0.58826    3.1753
# Age.at.Gluten.Introduction..months.15                                                                                       0.8474     1.1800   0.38623    1.8594
# Age.at.Gluten.Introduction..months.36                                                                                       0.7127     1.4031   0.28651    1.7728
# Age.at.Gluten.Introduction..months.4                                                                                        1.2831     0.7793   0.40838    4.0315
# Age.at.Gluten.Introduction..months.5                                                                                        1.6016     0.6244   0.64456    3.9794
# Age.at.Gluten.Introduction..months.6                                                                                        1.4266     0.7010   0.81241    2.5051
# Age.at.Gluten.Introduction..months.7                                                                                        1.4026     0.7129   0.87080    2.2593
# Age.at.Gluten.Introduction..months.8                                                                                        1.4387     0.6951   0.81194    2.5493
# Age.at.Gluten.Introduction..months.9                                                                                        1.5269     0.6549   0.86420    2.6977
# Age.at.Solid.Introduction..months.4                                                                                         0.1064     9.4010   0.01266    0.8936
# Age.at.Solid.Introduction..months.5                                                                                         0.1248     8.0143   0.01585    0.9820
# Age.at.Solid.Introduction..months.6                                                                                         0.1388     7.2049   0.01729    1.1144
# Age.at.Solid.Introduction..months.7                                                                                         0.1576     6.3453   0.01992    1.2466
# Age.at.Solid.Introduction..months.8                                                                                         0.1702     5.8760   0.01613    1.7956






```


coxph model - Adenovirus Lopburi070/2006/THA

Interpretation:
The hazard ratio for being USA patients is 0.3409, meaning USA patients have a 1/0.473=2.011 lower risk of develop Celiac disease, compared to Italy, at every time point during the study. This result is statistically significant with a p-value of 0.00184.
```{r}

glm.table.all$month <- as.numeric(glm.table.all$month)
glm.table.all$Dx.Status <- as.numeric(ifelse(glm.table.all$Dx.Status == "CONTROL",0,1))

Adenovirus_Lopburi.res.cox <- coxph(Surv(month, Dx.Status) ~ `Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months., data = glm.table.all)

summary(Adenovirus_Lopburi.res.cox)
#                                                                                                                          coef exp(coef)  se(coef)      z Pr(>|z|)   
# `Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA`  1.076278  2.933739  0.614758  1.751  0.07999 . 
# CountryUSA                                                                                                          -0.747149  0.473715  0.239875 -3.115  0.00184 **
# SexMale                                                                                                              0.335459  1.398583  0.186151  1.802  0.07153 . 
# Delivery.ModeVaginal                                                                                                 0.330215  1.391267  0.226641  1.457  0.14512   
# HLA.CategoryLow/No Risk                                                                                             -0.004593  0.995417  0.256104 -0.018  0.98569   
# HLA.CategoryStandard Risk                                                                                            0.078859  1.082051  0.187984  0.419  0.67485   
# feeding_first_yearBreastmilk_and_formula                                                                             0.104330  1.109967  0.162267  0.643  0.52025   
# feeding_first_yearFormula                                                                                            0.164560  1.178874  0.202602  0.812  0.41666   
# Age.at.Gluten.Introduction..months.11                                                                                0.338855  1.403340  0.429107  0.790  0.42972   
# Age.at.Gluten.Introduction..months.15                                                                               -0.036211  0.964437  0.387437 -0.093  0.92554   
# Age.at.Gluten.Introduction..months.36                                                                               -0.302294  0.739121  0.463995 -0.652  0.51472   
# Age.at.Gluten.Introduction..months.4                                                                                 0.258873  1.295470  0.584247  0.443  0.65770   
# Age.at.Gluten.Introduction..months.5                                                                                 0.424705  1.529140  0.467434  0.909  0.36357   
# Age.at.Gluten.Introduction..months.6                                                                                 0.330481  1.391638  0.290157  1.139  0.25471   
# Age.at.Gluten.Introduction..months.7                                                                                 0.340444  1.405572  0.242501  1.404  0.16035   
# Age.at.Gluten.Introduction..months.8                                                                                 0.364943  1.440432  0.291344  1.253  0.21035   
# Age.at.Gluten.Introduction..months.9                                                                                 0.429721  1.536829  0.289543  1.484  0.13777   
# Age.at.Solid.Introduction..months.4                                                                                 -2.184529  0.112531  1.085274 -2.013  0.04413 * 
# Age.at.Solid.Introduction..months.5                                                                                 -2.023971  0.132130  1.051403 -1.925  0.05423 . 
# Age.at.Solid.Introduction..months.6                                                                                 -1.929147  0.145272  1.062401 -1.816  0.06940 . 
# Age.at.Solid.Introduction..months.7                                                                                 -1.813862  0.163023  1.054447 -1.720  0.08540 . 
# Age.at.Solid.Introduction..months.8                                                                                 -1.702613  0.182207  1.201705 -1.417  0.15653  



#                                                                                                                     exp(coef) exp(-coef) lower .95 upper .95
# `Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA`    2.9337     0.3409   0.87930    9.7882
# CountryUSA                                                                                                             0.4737     2.1110   0.29603    0.7581
# SexMale                                                                                                                1.3986     0.7150   0.97104    2.0144
# Delivery.ModeVaginal                                                                                                   1.3913     0.7188   0.89226    2.1693
# HLA.CategoryLow/No Risk                                                                                                0.9954     1.0046   0.60257    1.6444
# HLA.CategoryStandard Risk                                                                                              1.0821     0.9242   0.74857    1.5641
# feeding_first_yearBreastmilk_and_formula                                                                               1.1100     0.9009   0.80758    1.5256
# feeding_first_yearFormula                                                                                              1.1789     0.8483   0.79252    1.7536
# Age.at.Gluten.Introduction..months.11                                                                                  1.4033     0.7126   0.60521    3.2540
# Age.at.Gluten.Introduction..months.15                                                                                  0.9644     1.0369   0.45132    2.0609
# Age.at.Gluten.Introduction..months.36                                                                                  0.7391     1.3530   0.29769    1.8351
# Age.at.Gluten.Introduction..months.4                                                                                   1.2955     0.7719   0.41221    4.0714
# Age.at.Gluten.Introduction..months.5                                                                                   1.5291     0.6540   0.61174    3.8223
# Age.at.Gluten.Introduction..months.6                                                                                   1.3916     0.7186   0.78803    2.4576
# Age.at.Gluten.Introduction..months.7                                                                                   1.4056     0.7115   0.87385    2.2608
# Age.at.Gluten.Introduction..months.8                                                                                   1.4404     0.6942   0.81377    2.5497
# Age.at.Gluten.Introduction..months.9                                                                                   1.5368     0.6507   0.87130    2.7107
# Age.at.Solid.Introduction..months.4                                                                                    0.1125     8.8865   0.01341    0.9442
# Age.at.Solid.Introduction..months.5                                                                                    0.1321     7.5683   0.01683    1.0374
# Age.at.Solid.Introduction..months.6                                                                                    0.1453     6.8836   0.01811    1.1655
# Age.at.Solid.Introduction..months.7                                                                                    0.1630     6.1341   0.02064    1.2876
# Age.at.Solid.Introduction..months.8                                                                                    0.1822     5.4883   0.01729    1.9207



```



check genus of picornaviridae
```{r}


count.genus.glm <- count.genus
count.genus.glm[count.genus.glm != 0] <- 1

# merge count table and metadata table
glm.table.genus.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.glm),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



glm.table.genus.all$month <- factor(glm.table.genus.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
glm.table.genus.all$Dx.Status <- factor(glm.table.genus.all$Dx.Status,levels = c("CONTROL","CELIAC"))



count.genus.abundance <- count.genus


# merge count table and metadata table
abundance.table.genus.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.genus.abundance),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown")



abundance.table.genus.all$month <- factor(abundance.table.genus.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
abundance.table.genus.all$Dx.Status <- factor(abundance.table.genus.all$Dx.Status,levels = c("CONTROL","CELIAC"))





Picornaviridae.genus <- rownames(count.genus)[rownames(count.genus) %like% "Picornaviridae"]

Picornaviridae.genus.shortname <- gsub("Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;","",Picornaviridae.genus)



abundance.table.all.picornaviridae <- abundance.table.genus.all %>%
                                      select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(Picornaviridae.genus)) %>%
                                      rename_with(~ gsub("^Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;", "", .))  %>%
  pivot_longer(cols = starts_with("Picornaviridae"),
               names_to = "Picornaviridae_Genus", 
               values_to = "Count") %>%
  group_by(month,Dx.Status,Picornaviridae_Genus) %>%
  mutate(total_count = sum(Count))



Picornaviridae_Genus_abundance.heatmap <- ggplot(abundance.table.all.picornaviridae, aes(x = Picornaviridae_Genus, y = month, fill = total_count) )+
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  scale_fill_gradient(low="white", high="black",na.value="white") +
  #geom_text(aes(label = log10(total_count+1)), color = "white", size = 2) + 
  facet_wrap(~Dx.Status) +
  labs(title = "Abundance",
       x = "Groups", y = "Timepoints", fill = "total_count") +
  #theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90, hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(Picornaviridae_Genus_abundance.heatmap,file ="~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/Picornaviridae_Genus_abundance.heatmap.pdf",width = 20,height = 10)



PA.table.all.picornaviridae <- glm.table.genus.all %>%
                                      select(patientID,Country,month,Dx.Status,disease_onset_details,all_of(Picornaviridae.genus)) %>%
                                      rename_with(~ gsub("^Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;", "", .))  %>%
  pivot_longer(cols = starts_with("Picornaviridae"),
               names_to = "Picornaviridae_Genus", 
               values_to = "Count") %>%
  group_by(month,Dx.Status,Picornaviridae_Genus) %>%
  mutate(total_count = sum(Count))



Picornaviridae_Genus_PA.heatmap <-ggplot(PA.table.all.picornaviridae, aes(x = Picornaviridae_Genus, y = month, fill = total_count)) +
  geom_tile(color = "black", size = 0.5) +  # Adding a white border between tiles
  #scale_fill_manual(values = c("0" = "white", "1" = "blue")) +  # Custom colors for absence and presence
  scale_fill_gradient(low="white", high="black") +
  geom_text(aes(label = total_count), color = "white", size = 3) + 
  facet_wrap(~Dx.Status) +
  labs(title = "PA numbers",
       x = "Groups", y = "Timepoints", fill = "total_PA") +
  theme_minimal() +
  theme(axis.text.x = element_text(size=15,face="bold",angle = 90,hjust = 1),
        axis.text.y = element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 15, face = "bold"))


ggsave(Picornaviridae_Genus_PA.heatmap,file ="~/Handley Lab Dropbox/16S/Celiac/plot/picornaviridae/Picornaviridae_Genus_PA.heatmap.pdf",width = 20,height = 10)



```



#------------------------Family Level-------------------------#


###############################
#  LRT on abundance of virus  #
###############################


# extract count table
```{r}

count.family <- count.raw %>%
                 unite("lineage", c("kingdom", "phylum", "class", "order", "family"), sep = ";", remove = FALSE) %>%
                 group_by(lineage) %>%
                 mutate(sum_count_species = sum(count)) %>%
                 ungroup() %>%
                 reshape2::dcast(lineage ~ sampleName, value.var = "count", fun.aggregate = sum) %>%
                 droplevels() %>%
                 filter(lineage != "NA;NA;NA;NA;NA;NA;NA") %>%
                 column_to_rownames("lineage")

                        

```



# time series analysis on pairwise data
# LRT (Likely Ratio Test)
The LRT examines two models for the counts, a full model with a certain number of terms and a reduced model, in which some of the terms of the full model are removed. The test determines if the increased likelihood of the data using the extra terms in the full model is more than expected if those extra terms are truly zero.
comparing the differences between case and control data at each timepoint.
```{r}

# modify metadata table for deseq analysis
metadata.final.deseq <- metadata.final %>%
                        column_to_rownames("sampleName") %>%
                        dplyr::rename("Disease_status" = "Dx.Status")
# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.deseq <- metadata.final.deseq[colnames(count.family),]

# make the month variable factor
metadata.final.deseq$month <- factor(metadata.final.deseq$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
metadata.final.deseq$Disease_status <- factor(metadata.final.deseq$Disease_status,levels = c("CONTROL","CELIAC"))

rownames(count.family) <- gsub("/","_",rownames(count.family))

# design the model
ddsTC <- DESeqDataSetFromMatrix(countData = count.family + 1,
                                colData = metadata.final.deseq,
                                design = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month + Disease_status:month)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
ddsTC <- DESeq(ddsTC, test="LRT", reduced = ~ Country + Sex + Delivery.Mode + HLA.Category + Disease_status + month)

# check the result of analysis
resTC <- results(ddsTC)

# extract the result table
res.table <- resTC[order(resTC$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)

resultsNames(ddsTC)
# "Intercept"                               "Country_USA_vs_ITALY"                    "Sex_Male_vs_Female"                      "Delivery.Mode_Vaginal_vs_C.Section"     
# "HLA.Category_Low.No.Risk_vs_High.Risk"   "HLA.Category_Standard.Risk_vs_High.Risk" "Disease_status_CELIAC_vs_CONTROL"        "month_18_vs_12"                         
# "month_24_vs_12"                          "month_30_vs_12"                          "month_36_vs_12"                          "month_48_vs_12"                         
# "month_54_vs_12"                          "month_60_vs_12"                          "month_72_vs_12"                          "month_84_vs_12"                         
# "Disease_statusCELIAC.month18"            "Disease_statusCELIAC.month24"            "Disease_statusCELIAC.month30"            "Disease_statusCELIAC.month36"           
# "Disease_statusCELIAC.month48"            "Disease_statusCELIAC.month54"            "Disease_statusCELIAC.month60"            "Disease_statusCELIAC.month72"           
# "Disease_statusCELIAC.month84" 



for (i in resultsNames(ddsTC)[2:25]){
  
    res.case_control <- results(ddsTC, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    write.csv(res.case_control,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_family/",i,"_sig_family.csv"))
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
      
       print(j)
        
        padj <- res.case_control$padj
        stats <- res.case_control$stat
        
        count.plot <- plotCounts(ddsTC, j,
                   intgroup = c("month","Disease_status"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Disease_status <- factor(count.plot$Disease_status,levels = c("CONTROL","CELIAC"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Disease_status, group = Disease_status)) + 
                geom_point() + 
                scale_color_manual(breaks = c("CONTROL","CELIAC"), 
                       values=c("#09bc8a","#d81e5b")) + 
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_family/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


res.case_control.list <- list()

ddsResNames <- resultsNames(ddsTC)[2:25]


for (i in (1:length(ddsResNames))){
   
      
      res.case_control.list[[i]] <-  results(ddsTC, name=ddsResNames[i], test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = ddsResNames[i]) %>%
                    rownames_to_column("rowname")
      

}


res.case_control.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.case_control.list)
res.case_control.total[is.na(res.case_control.total)] <- 0
res.case_control.total <- res.case_control.total %>%
                          column_to_rownames("rowname")



thr <- 3
res.case_control.total[res.case_control.total < -thr] <- -thr
res.case_control.total[res.case_control.total > thr] <- thr

ggsave(pheatmap(res.case_control.total, color = hcl.colors(50, "BluYl"), length=101,
                   cluster_col=FALSE,fontsize_row = 20,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/LRT/sig.family.heatmap.pdf",width = 30, height = 8, dpi=600)


```




                                                              #################################################
                                                              #   What taxa are pertantially predecing taxa   #               
                                                              #                                               #
                                                              #################################################


# ----------------------------Species level-----------------------------------#
```{r}

# extract the case samples
case_sampels <- metadata.final %>%
                filter(disease_onset_details != "Control") %>%
                pull(sampleName)



case_sampels_changeName <- metadata.final %>%
                           filter(disease_onset_details != "Control")


count.specis.case <- count.species %>%
                     select(all_of(case_sampels))



# find the taxa that are significantly different in case group at each timep point (higher and lower respectively)
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species/"

sig.res.species.table.list <- list.files("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_species/",pattern = glob2rx("Disease_statusCELIAC.mont*csv"))
# "Disease_statusCELIAC.month18_sig_species.csv" "Disease_statusCELIAC.month24_sig_species.csv" "Disease_statusCELIAC.month30_sig_species.csv"
# "Disease_statusCELIAC.month36_sig_species.csv" "Disease_statusCELIAC.month48_sig_species.csv" "Disease_statusCELIAC.month54_sig_species.csv"
# "Disease_statusCELIAC.month60_sig_species.csv" "Disease_statusCELIAC.month72_sig_species.csv" "Disease_statusCELIAC.month84_sig_species.csv"



for (i in sig.res.species.table.list){

     sig.taxa <- rownames(read.csv(paste0(file.path,i),row.names = "X"))

     if (length(sig.taxa) == 0){

       next

     }else{
       
     file.name <-lapply(strsplit(i,"[.]"),"[",2)
     month <-  paste0(gsub("month","",lapply(strsplit(file.name[[1]],"_"),"[",1)),"M")

     
     count.specis.case.time <- count.specis.case %>%
                               filter(rownames(.) %in% sig.taxa) %>%
                               select(contains(month))
     

     write.csv(count.specis.case.time,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/",file.name,".csv"))


     

     #get the new column names
     names(count.specis.case.time) <- case_sampels_changeName$disease_onset_details[match(names(count.specis.case.time), case_sampels_changeName$sampleName)]

     final_res <- t(count.specis.case.time) %>%
      data.frame(.) %>%
      rownames_to_column("disease_group") %>%
      mutate(disease_group = ifelse(disease_group %like% "Case_onset","Case_onset",paste0("Case_precede_",month)))%>%
      group_by(disease_group) %>%
      summarise_each(list(sum)) %>%
      column_to_rownames("disease_group") %>%
      t(.) 
     


     write.csv(final_res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/",month,"_final_res.csv"))
     
    }

}


# combine restuls tables
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/"

sig.res.species.final_res.list <- list.files(file.path,pattern = "_final_res")
#"18M_final_res.csv" "24M_final_res.csv" "30M_final_res.csv" "36M_final_res.csv" "48M_final_res.csv" "60M_final_res.csv" "84M_final_res.csv"


for (i in (1:length(sig.res.species.final_res.list))){
  print(i)
  
  final_res.list[[i]] <- read.csv(paste0(file.path,sig.res.species.final_res.list[i])) %>%
                        rename(Case_onset = paste0("Case_onset",i))
  
  
}



# merge them together
final_res.total <- Reduce(function(x, y) merge(x, y,by = "X",  all=TRUE), final_res.list)
final_res.total[is.na(final_res.total)] <- 0
final_res.total <- final_res.total %>%
                   column_to_rownames("X") %>%
                   select(contains("Case_precede"),Case_onset1) %>%
                   rename(Case_onset1 = "Case_onset") %>%
                   mutate(Ratio_precede = select(., Case_precede_18M:Case_precede_60M) %>% 
                                  rowSums(na.rm = TRUE) / rowSums(.))


write.csv(final_res.total,"~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_species_res_total_counts.csv")


final_res.total.heatmap <- final_res.total %>% 
                           select(-Ratio_precede) %>%
                           rownames_to_column("Species") %>%
                            pivot_longer(cols = Case_precede_18M:Case_onset,
                              names_to = "time", 
                              values_to = "count")


final_res.total.heatmap$time <- factor(final_res.total.heatmap$time,levels = c("Case_precede_18M","Case_precede_24M","Case_precede_30M","Case_precede_36M","Case_precede_48M","Case_precede_60M","Case_onset"))


final_res.total.p <- ggplot(final_res.total.heatmap,aes(x = time,y = Species,fill = log10(count))) +
  geom_tile(colour = "white") +
  #geom_text(aes(label = count), color = "white", size = 4) +
  scale_fill_gradient2(low = "white",
                       mid = "gray",
                       high = "black") +
  theme(axis.text = element_text(size = 30)) +
  theme(axis.text.x = element_text(angle = 90))

ggsave(final_res.total.p,file="~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_species_res_total_heatmap.pdf",width = 40, height = 20, dpi = 600)




```


#################################################
#                                               #               
#                                               #
#################################################


# create lagged variable
```{r}


count.species.precede <- count.species


# merge count table and metadata table
predece.table.all <- merge(metadata.final %>% column_to_rownames("sampleName"),t(count.species.precede),by = 0) %>%
                        filter(feeding_first_year != "Unknown") %>%
                        filter(Age.at.Solid.Introduction..months. != "Unknown") %>%
                        filter(Age.at.Gluten.Introduction..months. != "Unknown") #%>%
                        filter(Dx.Status == "CELIAC")


predece.table.all$month <- factor(predece.table.all$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
predece.table.all$Dx.Status <- factor(predece.table.all$Dx.Status,levels = c("CONTROL","CELIAC"))


# Create lagged variables for viral abundances (e.g., Virus1, Virus2)
predece.table.all <- predece.table.all %>%
  arrange(patientID, month) %>%
  group_by(patientID) %>%
  mutate(
    LagAstrovirus = lag(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus`, order_by = month),
    LagEnterovirus = lag(`Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Human enterovirus`, order_by = month),
    LagAnellovirus = lag(`Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;unclassified Anelloviridae genus;Gorilla anellovirus`, order_by = month),
    LagDependoparvovirus = lag(`Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Dependoparvovirus;Adeno-associated dependoparvovirus A`,order_by = month),
    LagLopburi = lag(`Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi070/2006/THA`,order_by = month)
  ) %>%
  group_by(patientID) %>%
  mutate(
    # Determine time to diagnosis (timepoint when diagnosed, or last timepoint if not diagnosed)
    TimeToDiagnosis = ifelse(any(disease_onset_details == "Case_onset"), min(month[disease_onset_details == "Case_onset"]), max(month)),
    
    # Create the event indicator (1 if diagnosed, 0 if censored)
    EventIndicator = ifelse(month == TimeToDiagnosis & disease_onset_details == "Case_onset", 1, 0)
  ) %>%
  ungroup()



library(survival)
surv_obj <- Surv(time = predece.table.all$TimeToDiagnosis, event = predece.table.all$EventIndicator)

cox_model <- coxph(surv_obj ~ `Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` + Country + Sex + Delivery.Mode + HLA.Category + feeding_first_year + Age.at.Gluten.Introduction..months. + Age.at.Solid.Introduction..months.,data = predece.table.all)

# Summarize the model
summary(cox_model)

# Impute NA values for lag variables (e.g., at TimePoint 12, no lag is available)
predece.table.all$LagAstrovirus[is.na(predece.table.all$LagAstrovirus)] <- 0
predece.table.all$LagEnterovirus[is.na(predece.table.all$LagEnterovirus)] <- 0
predece.table.all$LagAnellovirus[is.na(predece.table.all$LagAnellovirus)] <- 0
predece.table.all$`LagDependoparvovirus`[is.na(predece.table.all$`LagDependoparvovirus`)] <- 0
predece.table.all$`LagLopburi`[is.na(predece.table.all$`LagLopburi`)] <- 0



model_Astrovirus <- lmer(`Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Primate astrovirus` ~ LagAstrovirus + (1 | patientID), data = predece.table.all)


# View model summaries
summary(model_Astrovirus)


# Convert diagnosis time to a survival object
surv_obj <- Surv(time = predece.table.all$month, event = predece.table.all$Diagnosed)

# Fit a Cox Proportional Hazards model with lagged virus abundance as predictors
cox_model <- coxph(surv_obj ~ LagVirus1 + LagVirus2 + strata(PatientID), data = data)

# View the Cox model summary
summary(cox_model)


```




Family level
```{r}


# extract the case samples
case_sampels <- metadata.final %>%
                filter(disease_onset_details != "Control") %>%
                pull(sampleName)



case_sampels_changeName <- metadata.final %>%
                           filter(disease_onset_details != "Control")


count.family.case <- count.family %>%
                     select(all_of(case_sampels))



# find the taxa that are significantly different in case group at each timep point (higher and lower respectively)
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_family/"

sig.res.family.table.list <- list.files("~/Handley Lab Dropbox/16S/Celiac/plot/LRT/count_plots_family/",pattern = glob2rx("Disease_statusCELIAC.mont*csv"))
# "Disease_statusCELIAC.month18_sig_family.csv" "Disease_statusCELIAC.month24_sig_family.csv" "Disease_statusCELIAC.month30_sig_family.csv"
# "Disease_statusCELIAC.month36_sig_family.csv" "Disease_statusCELIAC.month48_sig_family.csv" "Disease_statusCELIAC.month54_sig_family.csv"
# "Disease_statusCELIAC.month60_sig_family.csv" "Disease_statusCELIAC.month72_sig_family.csv" "Disease_statusCELIAC.month84_sig_family.csv"



for (i in sig.res.family.table.list){

     sig.taxa <- rownames(read.csv(paste0(file.path,i),row.names = "X"))

     if (length(sig.taxa) == 0){

       next

     }else{
       
     file.name <-lapply(strsplit(i,"[.]"),"[",2)
     month <-  paste0(gsub("month","",lapply(strsplit(file.name[[1]],"_"),"[",1)),"M")

     
     count.family.case.time <- count.family.case %>%
                               filter(rownames(.) %in% sig.taxa) %>%
                               select(contains(month))
     

     write.csv(count.family.case.time,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_family/",file.name,".csv"))


     

     #get the new column names
     names(count.family.case.time) <- case_sampels_changeName$disease_onset_details[match(names(count.family.case.time), case_sampels_changeName$sampleName)]

     final_res <- t(count.family.case.time) %>%
      data.frame(.) %>%
      rownames_to_column("disease_group") %>%
      mutate(disease_group = ifelse(disease_group %like% "Case_onset","Case_onset",paste0("Case_precede_",month)))%>%
      group_by(disease_group) %>%
      summarise_each(list(sum)) %>%
      column_to_rownames("disease_group") %>%
      t(.) 
     


     write.csv(final_res,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_family/",month,"_final_res.csv"))
     
    }

}


# combine restuls tables
file.path <- "~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_family/"

sig.res.family.final_res.list <- list.files(file.path,pattern = "_final_res")
#"18M_final_res.csv" "24M_final_res.csv" "30M_final_res.csv" "36M_final_res.csv" "48M_final_res.csv" "60M_final_res.csv" "84M_final_res.csv"


final_res.list <- list()
for (i in (1:length(sig.res.family.final_res.list))){
  print(i)
  
  final_res.list[[i]] <- read.csv(paste0(file.path,sig.res.family.final_res.list[i])) %>%
                        rename(Case_onset = paste0("Case_onset",i))
  
  
}



# merge them together
final_res.total <- Reduce(function(x, y) merge(x, y,by = "X",  all=TRUE), final_res.list)
final_res.total[is.na(final_res.total)] <- 0
final_res.total <- final_res.total %>%
                   column_to_rownames("X") %>%
                   select(contains("Case_precede"),Case_onset1) %>%
                   rename(Case_onset1 = "Case_onset") %>%
                   mutate(Ratio_precede = select(., Case_precede_18M:Case_precede_60M) %>% 
                                  rowSums(na.rm = TRUE) / rowSums(.))
                   

write.csv(final_res.total,"~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_family_res_total_counts.csv")


final_res.total.heatmap <- final_res.total %>% 
                           select(-Ratio_precede) %>%
                           rownames_to_column("Family") %>%
                            pivot_longer(cols = Case_precede_18M:Case_onset,
                              names_to = "time", 
                              values_to = "count")


final_res.total.heatmap$time <- factor(final_res.total.heatmap$time,levels = c("Case_precede_18M","Case_precede_24M","Case_precede_30M","Case_precede_36M","Case_precede_48M","Case_precede_60M","Case_onset"))


final_res.total.p <- ggplot(final_res.total.heatmap,aes(x = time,y = Family,fill = log10(count))) +
  geom_tile(colour = "white") +
  #geom_text(aes(label = log10(count)), color = "white", size = 4) +
  scale_fill_gradient2(low = "white",
                       mid = "gray",
                       high = "black") +
  theme(axis.text = element_text(size = 15)) +
  theme(axis.text.x = element_text(angle = 90))

ggsave(final_res.total.p,file="~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/final_family_res_total_heatmap.pdf",width = 15, height = 5, dpi = 600)


```





#################################
#   early stage vs late stage   #               
#                               #
#################################


# extract the patients who have onset age younger than 30 months and older than 30 months
# First we want to compare the early onset group vs late onset group all together with limma mixed linear model
# use limma mixed linear model to check differential abundant between these two groups
```{r}

library(limma)
library(edgeR)

metadata.final.stage <- metadata.final %>%
                          filter(Dx.Status == "CELIAC") %>%
                          rename(Dx.Status = "Disease_status") %>%
                          mutate(Onset_stage = ifelse(Onset.Dx <= 30,"Early","Late")) %>%
                          column_to_rownames("sampleName")

table(metadata.final.stage$Onset_stage)
# Early  Late 
#    46   119 


count.specis.case <- count.species %>%
                     select(all_of(rownames(metadata.final.stage)))


# limma model
# get otu table
OTU.species <- count.specis.case


metadata.final.stage$Onset_stage <- factor(metadata.final.stage$Onset_stage,levels = c("Early","Late"))


design <- model.matrix(~ Onset_stage + Country + Sex + Delivery.Mode + HLA.Category + month,metadata.final.stage)
fit <- voomLmFit(OTU.species+1, design, block=metadata.final.stage$patientID, plot=FALSE)
fit <- eBayes(fit)
res <- topTable(fit, coef="Onset_stageLate",number=292)
sig <- topTable(fit, coef="Onset_stageLate",number=292) %>% filter(adj.P.Val < 0.05)
dim(sig)
# 0 6

```




# trajectory analysis (species)
```{r}


# modify metadata table for deseq analysis, extract only CELIAC samples
metadata.final.stage <- metadata.final %>%
                          filter(Dx.Status == "CELIAC") %>%
                          rename(Dx.Status = "Disease_status") %>%
                          mutate(Onset_stage = ifelse(Onset.Dx <= 30,"Early","Late")) %>%
                          column_to_rownames("sampleName")

# extract CELIAC samples from count table
count.species.celiac <- count.species[,rownames(metadata.final.stage)]


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.stage <- metadata.final.stage[colnames(count.species.celiac),]

# make the month variable factor
metadata.final.stage$month <- factor(metadata.final.stage$month,levels = c("12","18","24","30","36","48","54","60","72","84"))


rownames(count.species.celiac) <- gsub("/","_",rownames(count.species.celiac))

# design the model
dds <- DESeqDataSetFromMatrix(countData = count.species.celiac + 1,
                                colData = metadata.final.stage,
                                design = ~ month + Onset_stage + Country + Sex + Delivery.Mode + HLA.Category)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
dds <- DESeq(dds)

# check the result of analysis
res <- results(dds)


# extract the result table
res.table <- res[order(res$padj),]


# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)


resultsNames(dds)
# "Intercept"                               "month_18_vs_12"                          "month_24_vs_12"                         
# "month_30_vs_12"                          "month_36_vs_12"                          "month_48_vs_12"                         
# "month_54_vs_12"                          "month_60_vs_12"                          "month_72_vs_12"                         
# "month_84_vs_12"                          "Onset_stage_Late_vs_Early"               "Country_USA_vs_ITALY"                   
# "Sex_Male_vs_Female"                      "Delivery.Mode_Vaginal_vs_C.Section"      "HLA.Category_Low.No.Risk_vs_High.Risk"  
# "HLA.Category_Standard.Risk_vs_High.Risk"




for (i in resultsNames(dds)[2:16]){
  
    res.early_late <- results(dds, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    write.csv(res.early_late,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/count_plots_species/",i,"_sig_species.csv"))
    
    rownames(res.early_late) <- gsub("/","_",rownames(res.early_late))
    
    for (j in rownames(res.early_late)){
      
       print(j)
        
        padj <- res.early_late$padj
        stats <- res.early_late$stat
        
        count.plot <- plotCounts(dds, j,
                   intgroup = c("month","Onset_stage"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Onset_stage <- factor(count.plot$Onset_stage,levels = c("Early","Late"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Onset_stage, group = Onset_stage)) + 
                geom_point() + 
                scale_color_manual(breaks = c("Early", "Late"), 
                       values=c("#09bc8a","#d81e5b")) +
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/count_plots_species/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}



res.early_late.list <- list()

ddsResNames <- resultsNames(dds)[2:16]


for (i in (1:length(ddsResNames))){
   
      
      res.early_late.list[[i]] <-  results(dds, name=ddsResNames[i], test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = ddsResNames[i]) %>%
                    rownames_to_column("rowname")
      

}



res.early_late.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.early_late.list)
res.early_late.total[is.na(res.early_late.total)] <- 0
res.early_late.total <- res.early_late.total %>%
                          column_to_rownames("rowname")


thr <- 3
res.early_late.total[res.early_late.total < -thr] <- -thr
res.early_late.total[res.early_late.total > thr] <- thr


ggsave(pheatmap(res.early_late.total, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 18,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/sig.species.heatmap.pdf",width = 30, height = 30, dpi=600)


rownames(res.case_control.total)

# extract the rellevant comparisons and viruses and remake the heatmap
res.early_late.total.relevant <- res.early_late.total %>%
                                   select("Onset_stage_Late_vs_Early") %>%
                                   filter(!rownames(.) %in% c("Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Gyrovirus;Avian gyrovirus 2",
                                                             "Viruses;unclassified Viruses phylum;unclassified Viruses class;unclassified Viruses order;Anelloviridae;Betatorquevirus;Torque teno mini virus 8",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;unclassified Adenoviridae genus;Lophocebus aterrimus adenovirus",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Simian mastadenovirus H",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Rhesus adenovirus 58",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Human mastadenovirus G",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Human mastadenovirus E",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Human mastadenovirus B",
                                                             "Viruses;Preplasmiviricota;Tectiliviricetes;Rowavirales;Adenoviridae;Mastadenovirus;Adenovirus Lopburi078_2006_THA",
                                                             "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;California sea lion astrovirus 5",
                                                             "Viruses;Pisuviricota;Stelpaviricetes;Stellavirales;Astroviridae;unclassified Astroviridae genus;Astrovirus MLB3",
                                                             "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;unclassified Picornavirales family;unclassified Picornavirales genus;Picornavirales sp.",
                                                             "Viruses;Pisuviricota;Pisoniviricetes;Picornavirales;Picornaviridae;Enterovirus;Rhinovirus B",
                                                             "Viruses;Pisuviricota;Duplopiviricetes;Durnavirales;Picobirnaviridae;Picobirnavirus;Marmot picobirnavirus",
                                                             "Viruses;Pisuviricota;Duplopiviricetes;Durnavirales;Picobirnaviridae;Picobirnavirus;Human picobirnavirus",
                                                             "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;Protoparvovirus;Ungulate protoparvovirus 1",
                                                             "Viruses;Cossaviricota;Quintoviricetes;Piccovirales;Parvoviridae;unclassified Parvoviridae genus;unclassified Parvoviridae species"))
                                   


thr <- 3
res.early_late.total.relevant[res.early_late.total.relevant < -thr] <- -thr
res.early_late.total.relevant[res.early_late.total.relevant > thr] <- thr


ggsave(pheatmap(res.early_late.total.relevant, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 10,fontsize_col = 25),file="~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/sig.species.heatmap.relevant.pdf",width = 12, height = 15, dpi=600)








```



# trajectory analysis (family)
```{r}


# modify metadata table for deseq analysis, extract only CELIAC samples
metadata.final.stage <- metadata.final %>%
                          filter(Dx.Status == "CELIAC") %>%
                          rename(Dx.Status = "Disease_status") %>%
                          mutate(Onset_stage = ifelse(Onset.Dx <= 30,"Early","Late")) %>%
                          column_to_rownames("sampleName")

# extract CELIAC samples from count table
count.family.celiac <- count.family[,rownames(metadata.final.stage)]


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.stage <- metadata.final.stage[colnames(count.family.celiac),]

# make the month variable factor
metadata.final.stage$month <- factor(metadata.final.stage$month,levels = c("12","18","24","30","36","48","54","60","72","84"))


rownames(count.family.celiac) <- gsub("/","_",rownames(count.family.celiac))

# design the model
dds <- DESeqDataSetFromMatrix(countData = count.family.celiac + 1,
                                colData = metadata.final.stage,
                                design = ~ month + Onset_stage + Country + Sex + Delivery.Mode + HLA.Category)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
dds <- DESeq(dds)

# check the result of analysis
res <- results(dds)


# extract the result table
res.table <- res[order(res$padj),]


# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)


resultsNames(dds)
# "Intercept"                               "month_18_vs_12"                          "month_24_vs_12"                         
# "month_30_vs_12"                          "month_36_vs_12"                          "month_48_vs_12"                         
# "month_54_vs_12"                          "month_60_vs_12"                          "month_72_vs_12"                         
# "month_84_vs_12"                          "Onset_stage_Late_vs_Early"               "Country_USA_vs_ITALY"                   
# "Sex_Male_vs_Female"                      "Delivery.Mode_Vaginal_vs_C.Section"      "HLA.Category_Low.No.Risk_vs_High.Risk"  
# "HLA.Category_Standard.Risk_vs_High.Risk"




for (i in resultsNames(dds)[2:16]){
  
    res.early_late <- results(dds, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    write.csv(res.early_late,paste0("~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/count_plots_family/",i,"_sig_family.csv"))
    
    rownames(res.early_late) <- gsub("/","_",rownames(res.early_late))
    
    for (j in rownames(res.early_late)){
      
       print(j)
        
        padj <- res.early_late$padj
        stats <- res.early_late$stat
        
        count.plot <- plotCounts(dds, j,
                   intgroup = c("month","Onset_stage"), returnData = TRUE)
     
        count.plot$month <- factor(count.plot$month,levels = c("12","18","24","30","36","48","54","60","72","84"))
        count.plot$Onset_stage <- factor(count.plot$Onset_stage,levels = c("Early","Late"))

        p.count <- ggplot(count.plot,
                aes(x = month, y = count, color = Onset_stage, group = Onset_stage)) + 
                geom_point() + 
                scale_color_manual(breaks = c("Early", "Late"), 
                       values=c("#09bc8a","#d81e5b")) +
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() 
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/count_plots_family/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}



res.early_late.list <- list()

ddsResNames <- resultsNames(dds)[2:16]


for (i in (1:length(ddsResNames))){
   
      
      res.early_late.list[[i]] <-  results(dds, name=ddsResNames[i], test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = ddsResNames[i]) %>%
                    rownames_to_column("rowname")
      

}



res.early_late.total <- Reduce(function(x, y) merge(x, y,by = "rowname",  all=TRUE), res.early_late.list)
res.early_late.total[is.na(res.early_late.total)] <- 0
res.early_late.total <- res.early_late.total %>%
                          column_to_rownames("rowname")


thr <- 3
res.early_late.total[res.early_late.total < -thr] <- -thr
res.early_late.total[res.early_late.total > thr] <- thr


ggsave(pheatmap(res.early_late.total, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 20,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/early_vs_late_onset/sig.family.heatmap.pdf",width = 30, height = 10, dpi=600)



```





############################################################### Do not use below script for now ##############################################################

#################################################
#   What taxa are pertantially predecing taxa   #               
#                                               #
#################################################



# time series analysis on pairwise data (species level).
# LRT (Likely Ratio Test)
The LRT examines two models for the counts, a full model with a certain number of terms and a reduced model, in which some of the terms of the full model are removed. The test determines if the increased likelihood of the data using the extra terms in the full model is more than expected if those extra terms are truly zero.
comparing the differences between case and control data at each timepoint.


NOTE: If we run the results() function without specifying contrast or name, it will return the comparison of the last level of the last variable in the design formula over the first level of this variable. If the order of levels are not specified, they are ordered alphabetically by DESeq2.
```{r}


# modify metadata table for deseq analysis, extract only CELIAC samples
metadata.final.celiac <-  metadata.final %>%
                        rename(`Dx.Status` = "Disease_status") %>%
                        filter(Disease_status == ("CELIAC")) %>%
                        group_by(patientID) %>%
                        arrange(month,.by_group = TRUE) %>%
                        mutate(preceding_order = ifelse(disease_onset_details == "Case_onset","Case_onset",paste0("disease_preceding_",rev(row_number()-1)))) %>%
                        ungroup() %>%
                        column_to_rownames("sampleName")


# extract CELIAC samples from count table
count.species.celiac <- count.species[,rownames(metadata.final.celiac)]

# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.celiac <- metadata.final.celiac[colnames(count.species.celiac),]

# make the month variable factor
metadata.final.celiac$preceding_order <- factor(metadata.final.celiac$preceding_order,levels = c("Case_onset","disease_preceding_1","disease_preceding_2","disease_preceding_3","disease_preceding_4","disease_preceding_5","disease_preceding_6","disease_preceding_7","disease_preceding_8"))


rownames(count.species.celiac) <- gsub("/","_",rownames(count.species.celiac))

# design the model
dds <- DESeqDataSetFromMatrix(countData = count.species.celiac + 1,
                                colData = metadata.final.celiac,
                                design = ~ preceding_order)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
dds <- DESeq(dds)

# check the result of analysis
res <- results(dds)


# extract the result table
res.table <- res[order(res$padj),]


# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)


resultsNames(dds)
# "Intercept"                                         "preceding_order_disease_preceding_1_vs_Case_onset"
# "preceding_order_disease_preceding_2_vs_Case_onset" "preceding_order_disease_preceding_3_vs_Case_onset"
# "preceding_order_disease_preceding_4_vs_Case_onset" "preceding_order_disease_preceding_5_vs_Case_onset"
# "preceding_order_disease_preceding_6_vs_Case_onset" "preceding_order_disease_preceding_7_vs_Case_onset"
# "preceding_order_disease_preceding_8_vs_Case_onset"


for (i in resultsNames(dds)[2:9]){
  
    res.case_control <- results(dds, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
        
        padj <- res.case_control$padj
        stats <- res.case_control$stat
        
        count.plot <- plotCounts(dds, j,
                   intgroup = c("preceding_order"), returnData = TRUE)
     
        count.plot$preceding_order <- factor(count.plot$preceding_order,levels = c("Case_onset","disease_preceding_1","disease_preceding_2","disease_preceding_3","disease_preceding_4","disease_preceding_5","disease_preceding_6","disease_preceding_7","disease_preceding_8"))

        p.count <- ggplot(count.plot,
                aes(x = preceding_order, y = count,group = 1)) + 
                geom_jitter(width = 0.3) + 
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() +
                theme(axis.text.x = element_text(angle = 90))
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_species/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}


### let's make heatmap with the log2foldchange scores

res.case_control1 <- results(dds, name="preceding_order_disease_preceding_1_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_1_vs_Case_onset")

res.case_control2 <- results(dds, name="preceding_order_disease_preceding_2_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_2_vs_Case_onset")


res.case_control3 <- results(dds, name="preceding_order_disease_preceding_3_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_3_vs_Case_onset")

res.case_control4 <- results(dds, name="preceding_order_disease_preceding_4_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_4_vs_Case_onset")

res.case_control5 <- results(dds, name="preceding_order_disease_preceding_5_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_5_vs_Case_onset")


res.case_control6 <- results(dds, name="preceding_order_disease_preceding_6_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_6_vs_Case_onset")



res.case_control7 <- results(dds, name="preceding_order_disease_preceding_7_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_7_vs_Case_onset")


res.case_control8 <- results(dds, name="preceding_order_disease_preceding_8_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_8_vs_Case_onset")



total.case_control.res <- merge(merge(merge(merge(merge(merge(merge(res.case_control1,res.case_control2,by = 0,all = TRUE) %>% column_to_rownames("Row.names"),
                                            res.case_control3,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),res.case_control4,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),res.case_control5,by = 0,all = TRUE) %>% column_to_rownames("Row.names"),
                                res.case_control6,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),
                                res.case_control7,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),
                                res.case_control8,by = 0,all = TRUE)  %>% column_to_rownames("Row.names")


total.case_control.res[is.na(total.case_control.res)] <- 0

thr <- 3 
total.case_control.res[total.case_control.res < -thr] <- -thr
total.case_control.res[total.case_control.res > thr] <- thr


ggsave(pheatmap(total.case_control.res, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 20,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/sig.species.heatmap.pdf",width = 30, height = 30, dpi=600)



```



# time series analysis on pairwise data (family level).
# LRT (Likely Ratio Test)
The LRT examines two models for the counts, a full model with a certain number of terms and a reduced model, in which some of the terms of the full model are removed. The test determines if the increased likelihood of the data using the extra terms in the full model is more than expected if those extra terms are truly zero.
comparing the differences between case and control data at each timepoint.
```{r}


# modify metadata table for deseq analysis, extract only CELIAC samples
metadata.final.celiac <- metadata.final %>%
                        rename(`Dx.Status` = "Disease_status") %>%
                        filter(Disease_status == ("CELIAC")) %>%
                        group_by(patientID) %>%
                        arrange(month,.by_group = TRUE) %>%
                        mutate(preceding_order = ifelse(disease_onset_details == "Case_onset","Case_onset",paste0("disease_preceding_",rev(row_number()-1)))) %>%
                        ungroup() %>%
                        column_to_rownames("sampleName")


# extract CELIAC samples from count table
count.family.celiac <- count.family[,rownames(metadata.final.celiac)]


# make the order of rownames of metadata consistent with the colnames of count table otherwise there will be errors
metadata.final.celiac <- metadata.final.celiac[colnames(count.family.celiac),]

# make the month variable factor
metadata.final.celiac$preceding_order <- factor(metadata.final.celiac$preceding_order,levels = c("Case_onset","disease_preceding_1","disease_preceding_2","disease_preceding_3","disease_preceding_4","disease_preceding_5","disease_preceding_6","disease_preceding_7","disease_preceding_8"))


rownames(count.family.celiac) <- gsub("/","_",rownames(count.family.celiac))

# design the model
dds <- DESeqDataSetFromMatrix(countData = count.family.celiac + 1,
                                colData = metadata.final.celiac,
                                design = ~ preceding_order)

# analysis with Likelyhood ratio test, the reduced variables are disease_status and month
dds <- DESeq(dds)

# check the result of analysis
res <- results(dds)

# extract the result table
res.table <- res[order(res$padj),]

# extract the significant result table
res.table.sig <- res.table %>%
                 data.frame(.) %>%
                 filter(padj < 0.05)

dim(res.table.sig)
# 3 6

resultsNames(dds)
# "Intercept"                                         "preceding_order_disease_preceding_1_vs_Case_onset"
# "preceding_order_disease_preceding_2_vs_Case_onset" "preceding_order_disease_preceding_3_vs_Case_onset"
# "preceding_order_disease_preceding_4_vs_Case_onset" "preceding_order_disease_preceding_5_vs_Case_onset"
# "preceding_order_disease_preceding_6_vs_Case_onset" "preceding_order_disease_preceding_7_vs_Case_onset"
# "preceding_order_disease_preceding_8_vs_Case_onset"



for (i in resultsNames(dds)[2:9]){
  
    res.case_control <- results(dds, name=i, test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05)
    
    rownames(res.case_control) <- gsub("/","_",rownames(res.case_control))
    
    for (j in rownames(res.case_control)){
        
        padj <- res.case_control$padj
        stats <- res.case_control$stat
        
        count.plot <- plotCounts(dds, j,
                   intgroup = c("preceding_order"), returnData = TRUE)
     
        count.plot$preceding_order <- factor(count.plot$preceding_order,levels = c("Case_onset","disease_preceding_1","disease_preceding_2","disease_preceding_3","disease_preceding_4","disease_preceding_5","disease_preceding_6","disease_preceding_7","disease_preceding_8"))

        p.count <- ggplot(count.plot,
                aes(x = preceding_order, y = count,group = 1)) + 
                geom_jitter(width = 0.3) + 
                labs(caption = paste0(i,"\n",j,"\npadj: ",padj,"\nstats: ",stats)) +
                stat_summary(fun.y=mean, geom="line") +
                scale_y_log10() +
                theme(axis.text.x = element_text(angle = 90))
  
        fileName <- paste0("~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/count_plots_family/",i,"_",j,"_count_plot.pdf")
        ggsave(p.count,file = fileName,width = 10,height = 4,dpi = 600)
      
      
    }
  
  
}



res.case_control1 <- results(dds, name="preceding_order_disease_preceding_1_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_1_vs_Case_onset")

res.case_control2 <- results(dds, name="preceding_order_disease_preceding_2_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_2_vs_Case_onset")


res.case_control3 <- results(dds, name="preceding_order_disease_preceding_3_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_3_vs_Case_onset")

res.case_control4 <- results(dds, name="preceding_order_disease_preceding_4_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_4_vs_Case_onset")

res.case_control5 <- results(dds, name="preceding_order_disease_preceding_5_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_5_vs_Case_onset")


res.case_control6 <- results(dds, name="preceding_order_disease_preceding_6_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_6_vs_Case_onset")



res.case_control7 <- results(dds, name="preceding_order_disease_preceding_7_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_7_vs_Case_onset")


res.case_control8 <- results(dds, name="preceding_order_disease_preceding_8_vs_Case_onset", test="Wald") %>%
                    data.frame(.) %>%
                    filter(padj < 0.05) %>%
                    select(log2FoldChange) %>% 
                    rename("log2FoldChange" = "preceding_order_disease_preceding_8_vs_Case_onset")



total.case_control.res <- merge(merge(merge(merge(merge(merge(merge(res.case_control1,res.case_control2,by = 0,all = TRUE) %>% column_to_rownames("Row.names"),
                                            res.case_control3,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),res.case_control4,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),res.case_control5,by = 0,all = TRUE) %>% column_to_rownames("Row.names"),
                                res.case_control6,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),
                                res.case_control7,by = 0,all = TRUE)  %>% column_to_rownames("Row.names"),
                                res.case_control8,by = 0,all = TRUE)  %>% column_to_rownames("Row.names")


total.case_control.res[is.na(total.case_control.res)] <- 0

thr <- 3 
total.case_control.res[total.case_control.res < -thr] <- -thr
total.case_control.res[total.case_control.res > thr] <- thr


ggsave(pheatmap(total.case_control.res, breaks=seq(from=-thr, to=thr, length=101),
                   cluster_col=FALSE,fontsize_row = 15,fontsize_col = 20),file="~/Handley Lab Dropbox/16S/Celiac/plot/time_series_on_case/sig.family.heatmap.pdf",width = 15, height = 12, dpi=600)



```



